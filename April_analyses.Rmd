---
title: "Various analyses - April 2024, final dataset"
author: "Ana Macanovic"
date: "2024-04-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```


This is a first draft of our main analyses.

Load the packages:
```{r message=  F, warning = F, eval = T}
library(groundhog)
packages_to_load <- c("readr", "dplyr", "tidyr", 
                      "ggplot2", "gridExtra", "cowplot",
                      "tidyverse", "RPostgres", "markovchain"
                      , "RPostgres", "lubridate", "psych",
                      "gridExtra", "DescTools", "marginaleffects",
                      "panelr", "skimr", "margins",
                      "lmtest", "sandwich", "rstatix", "ggpubr",
                      "stargazer","plm", "grid")
groundhog.library(packages_to_load, date = "2023-12-01")
#groundhog.library(c("ggeffects", "insight"), date = "2024-04-15")

install.packages("insight")
library(insight)
library(ggeffects)
source("helper_functions.R")
```

Load the panel:
```{r warning = F, message = F}
prof_panel_coa <- read_csv("panel_datasets/prof_panel_tidy_26_4.csv")

prof_panel_filter <- filter(prof_panel_coa,
                            year < 2024)
```


# Explore representation across different data sources:
```{r}
sources_check <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))
```

## News data

How many professors have at least one mention?
```{r}
sources_check$any_news <- ifelse(sources_check$news_all_total > 0, TRUE, FALSE)

table(sources_check$any_news)
prop.table(table(sources_check$any_news))
```
96% of professors in our data - 6499 of them, has at least one news mention.

On average, a professor in our dataset has accumulated 68.9 mentions throughout
their career:
```{r}
mean(sources_check$news_all_total, na.rm = TRUE)
```
Or, 2.65 mentions per year:
```{r}
mean(prof_panel_filter$news_allall, na.rm = TRUE)
```



Breakdown by news article type:
```{r, fig.width=12, warning = F, message = F}
news_type_source <- sources_check %>%
  select(profile_id, general_field, entry_batch_2023, inferred_gender, news_national_total:news_intl_total)
#news_type$news_all_total <- rowSums(news_type[, 5:9])
colnames(news_type_source) <- str_remove(str_remove(str_remove(colnames(news_type_source), "news_"), "_total"), "lexis_")
colnames(news_type_source)[5:8] <- c("National news",
                                     "Regional news",
                                     "Other news",
                                     "International news")

news_type <- news_type_source %>%
  pivot_longer(cols = c(`National news`:`International news`))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender, name)%>%
  summarise(
    profs = n(),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  group_by(general_field)%>%
  mutate(m_prop = round(sum_m/sum(sum_m, na.rm = TRUE),3),
         w_prop = round(sum_w/sum(sum_w, na.rm = TRUE), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

news_overall <- news_type_source %>%
  pivot_longer(cols = c(`National news`:`International news`))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender)%>%
  summarise(
    profs = n_distinct(profile_id),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

news_overall$name <- "All news"
news_overall <- news_overall[colnames(news_type)]

news_type <- rbind(news_type,
                   news_overall)

news_overall_overall <- news_type_source %>%
  pivot_longer(cols = c(`National news`:`International news`))%>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender)%>%
  summarise(
    profs = n_distinct(profile_id),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

news_overall_overall$name <- "All news"
news_overall_overall$general_field <- "All fields"
news_overall_overall <- news_overall_overall[colnames(news_type)]

news_type <- rbind(news_type,
                   news_overall_overall)


news_type <- news_type %>%
  arrange(general_field, name)%>%
  select(general_field:sum_w, m_ave, w_ave, m_prop, w_prop)

colnames(news_type) <- c("Field",
                         "News type",
                         "N professors - men",
                         "N professors - women",
                         "News mentions - men",
                         "News mentions - women",
                         "Avg. news mentions - men",
                         "Avg. news mentions - women",
                         "Share mentions per source - men",
                         "Share mentions per source - women")

# output to results
write_csv(news_type, "Plots_april/Supplemental/T_news_source.csv")
knitr::kable(news_type)
```

## Altmetric data

How many professors have at least one mention?
```{r}
sources_check$any_alt <- ifelse(sources_check$alt_online_all_total > 0, TRUE, FALSE)

table(sources_check$any_alt)
prop.table(table(sources_check$any_alt))
```
78% of professors in our data - 5301 of them, has at least one news mention.

On average, a professor in our dataset has accumulated 102.7 online mentions throughout
their career:
```{r}
mean(sources_check$alt_online_all_total, na.rm = TRUE)
```
Or, 8.3 mentions per year:
```{r}
mean(prof_panel_filter$alt_online_all, na.rm = TRUE)
```

Check the averages breakdown:
```{r, fig.width=12, warning = F, message = F}
online_news_type_source <- sources_check %>%
  select(profile_id, general_field, entry_batch_2023, inferred_gender, alt_news_aggregator_total:alt_science_news_total)
#news_type$news_all_total <- rowSums(news_type[, 5:9])
colnames(online_news_type_source) <- str_remove(str_remove(str_remove(colnames(online_news_type_source), "alt_"), "_total"), "lexis_")
colnames(online_news_type_source)[5:14] <- c("News aggregator",
                                     "Online blog",
                                     "Science news aggregator",
                                     "Finance news",
                                     "General interest - local",
                                     "General interest",
                                     "Medical portals",
                                     "Other news",
                                     "Popular science news",
                                     "Science news")

online_news_type <- online_news_type_source %>%
  pivot_longer(cols = c(`News aggregator`:`Science news`))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender, name)%>%
  summarise(
    profs = n(),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  group_by(general_field)%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

online_news_overall <- online_news_type_source %>%
  pivot_longer(cols = c(`News aggregator`:`Science news`))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender)%>%
  summarise(
    profs = n_distinct(profile_id),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

online_news_overall$name <- "All news"
online_news_overall <- online_news_overall[colnames(online_news_type)]

online_news_type <- rbind(online_news_type,
                   online_news_overall)

online_news_overall_overall <- online_news_type_source %>%
  pivot_longer(cols = c(`News aggregator`:`Science news`))%>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender)%>%
  summarise(
    profs = n_distinct(profile_id),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

online_news_overall_overall$name <- "All news"
online_news_overall_overall$general_field <- "All fields"
online_news_overall_overall <- online_news_overall_overall[colnames(online_news_type)]

online_news_type <- rbind(online_news_type,
                   online_news_overall_overall)

online_news_type <- online_news_type %>%
  arrange(general_field, name)%>%
  select(general_field:sum_w, m_ave, w_ave, m_prop, w_prop)

colnames(online_news_type) <- c("Field",
                         "News type",
                         "N professors - men",
                         "N professors - women",
                         "News mentions - men",
                         "News mentions - women",
                         "Avg. news mentions - men",
                         "Avg. news mentions - women",
                         "Share mentions per source - men",
                         "Share mentions per source - women")

# output to results
write_csv(online_news_type, "Plots_april/Supplemental/T_online_news_source.csv")
knitr::kable(online_news_type)
```

## Twitter data

How many professors have at least one mention?
```{r}
sources_check$any_alt <- ifelse(sources_check$alt_twitter > 0, TRUE, FALSE)

table(sources_check$any_alt)
prop.table(table(sources_check$any_alt))
```
78% of professors in our data - 5301 of them, has at least one news mention.

On average, a professor in our dataset has accumulated 102.7 online mentions throughout
their career:
```{r}
mean(sources_check$alt_online_all_total, na.rm = TRUE)
```
Or, 8.3 mentions per year:
```{r}
mean(prof_panel_filter$alt_online_all, na.rm = TRUE)
```

```{r, fig.width=12, warning = F, message = F}
twitter_type_source <- sources_check %>%
  select(profile_id, general_field, entry_batch_2023, inferred_gender, alt_twitter_total)
#news_type$news_all_total <- rowSums(news_type[, 5:9])
colnames(twitter_type_source) <- str_remove(str_remove(str_remove(colnames(twitter_type_source), "alt_"), "_total"), "lexis_")
colnames(twitter_type_source)[5] <- c("Twitter")

twitter_type <- twitter_type_source %>%
  pivot_longer(cols = c(`Twitter`))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender)%>%
  summarise(
    profs = n(),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  group_by(general_field)%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

twitter_overall <- twitter_type_source %>%
  pivot_longer(cols = c(`Twitter`))%>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender)%>%
  summarise(
    profs = n_distinct(profile_id),
    sum = sum(value, na.rm = TRUE))%>%
  pivot_wider(names_from = inferred_gender, values_from = c(profs,sum))%>%
  mutate(m_prop = round(sum_m/sum(sum_m),3),
         w_prop = round(sum_w/sum(sum_w), 3),
         m_ave = round(sum_m/profs_m, 3),
         w_ave = round(sum_w/profs_w, 3))

twitter_overall$general_field <- "All fields"
twitter_overall <- twitter_overall[colnames(twitter_type)]

twitter_type <- rbind(twitter_type,
                   twitter_overall)

# output to results
write_csv(twitter_type, "Plots_april/Supplemental/T_twitter.csv")
knitr::kable(twitter_type)
```


# Women's representation across the board

First, get representation per field in our dataset:
(? professors)
```{r}
repr_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)

repr_field_2023$share_women_field <- repr_field_2023$w/(repr_field_2023$m+repr_field_2023$w)

```

Now get the representation of women among the top 10% and 20% of researchers in terms
of total fame in their field in 2023 (based on their entry batch):
```{r}
# first, get the latest year in the panel for each prof
women_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))

# and now set the final year as 2023, assuming there was no attention after
# whatever the last year is in the dataset (quite some professors with
# 0 mentions even in this last year, so we want to keep them for correct
# shares)
women_field_2023$year <- 2023

# get their decile based on their total performance within their entry batch
women_field_2023 <- women_field_2023 %>%
  filter(!is.na(general_field))%>%
  select(profile_id, year, inferred_gender, general_field, entry_batch_2023, count_pubs_total,
         cited_by_total_all, alt_online_all_total, news_all_total, alt_twitter_total)%>%
  replace(is.na(.), 0)%>%
  group_by(general_field, entry_batch_2023)%>%
  mutate(
         `Publications` = ntile(-count_pubs_total, 20),
         `Citations` = ntile(-cited_by_total_all, 20),    
         `Online news` = ntile(-alt_online_all_total, 20),
         `News` = ntile(-news_all_total, 20),
         `Twitter` = ntile(-alt_twitter_total, 20))
```

### % women among scientists in top n%
Get shares of women among top n% scientists per attention domain:
```{r}
# rearrange the dataset to get counts of women and men in each decile
# then leave only top 10 and 20
share_women_field_2023 <- women_field_2023 %>%
  ungroup()%>%
  select(profile_id, year, inferred_gender, general_field, `Publications`:`Twitter`)%>%
  pivot_longer(`Publications`:`Twitter`)%>%
  group_by(general_field, inferred_gender, name, value)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)%>%
  group_by(general_field, name)%>%
  mutate(m = cumsum(m),
         w = cumsum(w))%>%
  filter(value %in% c(1, 2, 3, 4))
 
share_women_field_2023$share_women <- share_women_field_2023$w/(share_women_field_2023$m+share_women_field_2023$w) 
```
Combine the field representation with the attention representation:
```{r}
repr_field_2023$name <- "overall"
repr_field_2023$value <- 0

repr_field_2023 <- repr_field_2023[c(colnames(share_women_field_2023)[1:5],"share_women_field")]

share_women_field_2023 <- merge(share_women_field_2023,
                                repr_field_2023[c("general_field", "share_women_field")],
                                by = "general_field")

share_women_field_2023$share_women_field <- ifelse(share_women_field_2023$name == "News",
                                                   share_women_field_2023$share_women_field,
                                                   NA)
```

Plot this out:

Top 10%:
```{r warning = F}
repr_attn_5 <- share_women_field_2023 %>%
  filter(value == 1 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
  geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(a) top 5% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

repr_attn_10 <- share_women_field_2023 %>%
  filter(value == 2 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
  geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(b) top 10% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

repr_attn_15 <- share_women_field_2023 %>%
  filter(value == 3 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
    geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(c) top 15% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

repr_attn_20 <- share_women_field_2023 %>%
  filter(value == 4 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
    geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(d) top 20% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))
```


Plot these two next to each other:
```{r fig.width=10, fig.height=4, warning = F}
legend <- get_legend(
  # create some space to the left of the legend
  repr_attn_10
)

combi_plot <- cowplot::plot_grid(
                    repr_attn_10 + theme(legend.position="none") + ggtitle("(a) top 10% of attention domains"),
                    repr_attn_20 + theme(legend.position="none",
                                        axis.title.y=element_blank(),
                                        axis.text.y=element_blank())+ggtitle("(b) top 20% of attention domains"),
                    legend,
                    ncol = 3,
                    rel_widths = c(1, 0.8, 0.22))


ggsave2(
  filename = "Plots_april/Plot_1.png",
  plot = combi_plot,
  width = 10,
  height = 4,
  units = c("in"),
  dpi = 300,
  bg = "white"
)

combi_plot
```


# Compare means and distributions
## Means comparison

```{r}
sources_check <- sources_check%>%
  filter(!is.na(general_field))
```

### Overall
```{r}
overall_comparisons <- data.frame(matrix(NA, ncol = 6, nrow = 1))
i <- 1
overall_comparisons[i, 1] <- "overall"
overall_comparisons[i, 2] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 3] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 4] <- round(wilcox.test(news_all_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 5] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 6] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)

colnames(overall_comparisons) <-  c("field", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")


overall_comparisons

mean_values <- sources_check %>%
  group_by(inferred_gender)%>%
  summarise(pubs_total = mean(count_pubs_total, na.rm = TRUE),
            citations_total = mean(cited_by_total_all, na.rm = TRUE),
            news_total = mean(news_all_total, na.rm = TRUE),
            online_news_total = mean(alt_online_all_total, na.rm = TRUE),
            twitter_total =  mean(alt_twitter_total, na.rm = TRUE))%>%
  mutate(across(2:6, \(x) round(x, 1)))

mean_values
overall_comparisons
```


### Within fields

```{r}
fields <- unique(prof_panel_filter$general_field)
fields <- fields[!is.na(fields)]
field_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = length(fields)))

for (i in 1:length(fields)){
  field <- fields[i]
  data <- filter(sources_check, 
                 general_field == field)
  field_comparisons[i, 1] <- field
  field_comparisons[i, 2] <- nrow(data)
  field_comparisons[i, 3] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 4] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 5] <- round(wilcox.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 6] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 7] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
}

colnames(field_comparisons) <- c("field", "profs", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")
field_comparisons
```

### Within year groups
```{r}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]
year_groups_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = length(year_groups)))

for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  data <- filter(sources_check, 
                 entry_batch_2023 == year_group)
  
  year_groups_comparisons[i, 1] <- year_group
  year_groups_comparisons[i, 2] <- nrow(data)
  year_groups_comparisons[i, 3] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  year_groups_comparisons[i, 4] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  year_groups_comparisons[i, 5] <- round(wilcox.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  year_groups_comparisons[i, 6] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  year_groups_comparisons[i, 7] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
}

colnames(year_groups_comparisons) <- c("field", "profs", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")
year_groups_comparisons
```


### Within year groups and fields
```{r warning = F}
year_groups_field_comparisons <- data.frame(matrix(NA, ncol = 8, nrow = length(year_groups)*length(fields)))
row_index <- 0

for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    field <- fields[j]
    data <- filter(sources_check, 
                   years_since_entry == year_group & general_field == field)
    
    women <- filter(data, inferred_gender == "w")
    men <- filter(data, inferred_gender == "m")
    
    if (length(unique(data$inferred_gender)) != 2){
      year_groups_field_comparisons[row_index+j, 1] <- year_group
      year_groups_field_comparisons[row_index+j, 2] <- field
      year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
      year_groups_field_comparisons[row_index+j, 4] <- NA
      year_groups_field_comparisons[row_index+j, 5] <- NA
      year_groups_field_comparisons[row_index+j, 6] <- NA
      year_groups_field_comparisons[row_index+j, 7] <- NA
      year_groups_field_comparisons[row_index+j, 8] <- NA
    }else{
      if (length(which(colSums(data[c("alt_online_all_total", "news_all_total", "alt_twitter_total", "cited_by_total_all", "count_pubs_total")]) == 0)) > 0){
        year_groups_field_comparisons[row_index+j, 1] <- year_group
        year_groups_field_comparisons[row_index+j, 2] <- field
        year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_comparisons[row_index+j, 4] <- NA
        year_groups_field_comparisons[row_index+j, 5] <- NA
        year_groups_field_comparisons[row_index+j, 6] <- NA
        year_groups_field_comparisons[row_index+j, 7] <- NA
        year_groups_field_comparisons[row_index+j, 8] <- NA
        
      }else{
        year_groups_field_comparisons[row_index+j, 1] <- year_group
        year_groups_field_comparisons[row_index+j, 2] <- field
        year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_comparisons[row_index+j, 4] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 5] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 6] <- round(wilcox.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 7] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 8] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
      }
    }
  }
  row_index <- row_index + 4 
}

colnames(year_groups_field_comparisons) <- c("year_group", "field", "profs", "pubs_total", "citations_total",
                                       "news_total", "online_news_total", "twitter_total")
year_groups_field_comparisons
```

### Writing this out
```{r}
write_csv(overall_comparisons, "Plots_april/Supplemental/mean_overall.csv")
write_csv(field_comparisons, "Plots_april/Supplemental/mean_year.csv")
write_csv(field_comparisons, "Plots_april/Supplemental/mean_field.csv")
write_csv(year_groups_field_comparisons, "Plots_april/Supplemental/mean_year_field.csv")
```


## Distributions comparison

### Overall
```{r}
overall_dist_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = 1))
i <- 1
women <- filter(sources_check, inferred_gender == "w")
men <- filter(sources_check, inferred_gender == "m")

overall_dist_comparisons[i, 1] <- "overall"
overall_dist_comparisons[i, 2] <- nrow(prof_panel_filter)
overall_dist_comparisons[i, 3] <- round(ks.test(women$count_pubs_total, men$count_pubs_total)$p.value, 5)
overall_dist_comparisons[i, 4] <- round(ks.test(women$cited_by_total_all, men$cited_by_total_all)$p.value, 5)
overall_dist_comparisons[i, 5] <- round(ks.test(women$news_all_total, men$news_all_total)$p.value, 5)
overall_dist_comparisons[i, 6] <- round(ks.test(women$alt_online_all_total, men$alt_online_all_total)$p.value, 5)
overall_dist_comparisons[i, 7] <- round(ks.test(women$alt_twitter_total, men$alt_twitter_total)$p.value, 5)

colnames(overall_dist_comparisons) <- c("overall", "profs", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")


overall_dist_comparisons
```


### Within fields

```{r}
fields <- unique(sources_check$general_field)
fields <- fields[!is.na(fields)]
field_dist_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = length(fields)))

for (i in 1:length(fields)){
  field <- fields[i]
  data <- filter(sources_check, 
                 general_field == field)
  women <- filter(data, inferred_gender == "w")
  men <- filter(data, inferred_gender == "m")
  
  field_dist_comparisons[i, 1] <- field
  field_dist_comparisons[i, 2] <- nrow(data)
  field_dist_comparisons[i, 3] <- round(ks.test(women$count_pubs_total, men$count_pubs_total)$p.value, 5)
  field_dist_comparisons[i, 4] <- round(ks.test(women$cited_by_total_all, men$cited_by_total_all)$p.value, 5)
  field_dist_comparisons[i, 5] <- round(ks.test(women$news_all_total, men$news_all_total)$p.value, 5)
  field_dist_comparisons[i, 6] <- round(ks.test(women$alt_online_all_total, men$alt_online_all_total)$p.value, 5)
  field_dist_comparisons[i, 7] <- round(ks.test(women$alt_twitter_total, men$alt_twitter_total)$p.value, 5)
}

colnames(field_dist_comparisons) <- c("field","profs", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")
field_dist_comparisons
```

### Within year groups
```{r}
year_groups <- unique(prof_panel_filter$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]
year_groups_dist_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = length(year_groups)))

for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  data <- filter(sources_check, 
                 years_since_entry == year_group)
  
  women <- filter(data, inferred_gender == "w")
  men <- filter(data, inferred_gender == "m")
  
  year_groups_dist_comparisons[i, 1] <- year_group
  year_groups_dist_comparisons[i, 2] <- nrow(data)
  year_groups_dist_comparisons[i, 3] <- round(ks.test(women$count_pubs_total, men$count_pubs_total)$p.value, 5)
  year_groups_dist_comparisons[i, 4] <- round(ks.test(women$cited_by_total_all, men$cited_by_total_all)$p.value, 5)
  year_groups_dist_comparisons[i, 5] <- round(ks.test(women$news_all_total, men$news_all_total)$p.value, 5)
  year_groups_dist_comparisons[i, 6] <- round(ks.test(women$alt_online_all_total, men$alt_online_all_total)$p.value, 5)
  year_groups_dist_comparisons[i, 7] <- round(ks.test(women$alt_twitter_total, men$alt_twitter_total)$p.value, 5)
}

colnames(year_groups_dist_comparisons) <- c("field", "profs", "pubs_total", "citations_total",
                                 "news_total", "online_news_total", "twitter_total")
year_groups_dist_comparisons
```
### Within year groups and fields
```{r warning = F}
year_groups_field_dist_comparisons <- data.frame(matrix(NA, ncol = 8, nrow = length(year_groups)*length(fields)))
row_index <- 0

for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    field <- fields[j]
    data <- filter(sources_check, 
                   years_since_entry == year_group & general_field == field)
    
    women <- filter(data, inferred_gender == "w")
    men <- filter(data, inferred_gender == "m")
    
    if (length(unique(data$inferred_gender)) != 2){
      year_groups_field_dist_comparisons[row_index+j, 1] <- year_group
      year_groups_field_dist_comparisons[row_index+j, 2] <- field
      year_groups_field_dist_comparisons[row_index+j, 3] <- nrow(data)
      year_groups_field_dist_comparisons[row_index+j, 4] <- NA
      year_groups_field_dist_comparisons[row_index+j, 5] <- NA
      year_groups_field_dist_comparisons[row_index+j, 6] <- NA
      year_groups_field_dist_comparisons[row_index+j, 7] <- NA
      year_groups_field_dist_comparisons[row_index+j, 8] <- NA
    }else{
      if (length(which(colSums(data[c("alt_online_all_total", "news_all_total", "alt_twitter_total", "cited_by_total_all", "count_pubs_total")]) == 0)) > 0){
        year_groups_field_dist_comparisons[row_index+j, 1] <- year_group
        year_groups_field_dist_comparisons[row_index+j, 2] <- field
        year_groups_field_dist_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_dist_comparisons[row_index+j, 4] <- NA
        year_groups_field_dist_comparisons[row_index+j, 5] <- NA
        year_groups_field_dist_comparisons[row_index+j, 6] <- NA
        year_groups_field_dist_comparisons[row_index+j, 7] <- NA
        year_groups_field_dist_comparisons[row_index+j, 8] <- NA
        
      }else{
        year_groups_field_dist_comparisons[row_index+j, 1] <- year_group
        year_groups_field_dist_comparisons[row_index+j, 2] <- field
        year_groups_field_dist_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_dist_comparisons[row_index+j, 4] <- round(ks.test(women$count_pubs_total, men$count_pubs_total)$p.value, 5)
        year_groups_field_dist_comparisons[row_index+j, 5] <- round(ks.test(women$cited_by_total_all, men$cited_by_total_all)$p.value, 5)
        year_groups_field_dist_comparisons[row_index+j, 6] <- round(ks.test(women$news_all_total, men$news_all_total)$p.value, 5)
        year_groups_field_dist_comparisons[row_index+j, 7] <- round(ks.test(women$alt_online_all_total, men$alt_online_all_total)$p.value, 5)
        year_groups_field_dist_comparisons[row_index+j, 8] <- round(ks.test(women$alt_twitter_total, men$alt_twitter_total)$p.value, 5)
      }
    }
  }
  row_index <- row_index + 4 
}

colnames(year_groups_field_dist_comparisons) <- c("year_group", "field", "profs", "pubs_total", "citations_total",
                                       "news_total", "online_news_total", "twitter_total")
year_groups_field_dist_comparisons
```


### Writing this out
```{r}
write_csv(overall_dist_comparisons, "Plots_april/Supplemental/dist_overall.csv")
write_csv(field_dist_comparisons, "Plots_april/Supplemental/dist_year.csv")
write_csv(field_dist_comparisons, "Plots_april/Supplemental/dist_field.csv")
write_csv(year_groups_field_dist_comparisons, "Plots_april/Supplemental/dist_year_field.csv")
```



# Regression models

Binary variables for any attention:
```{r}
prof_panel_filter$any_news <- as.factor(ifelse(prof_panel_filter$news_all > 0, 1, 0))
prof_panel_filter$any_news_l <- as.factor(ifelse(prof_panel_filter$news_all_l > 0, 1, 0))

prof_panel_filter$any_online_news <- as.factor(ifelse(prof_panel_filter$alt_online_all > 0, 1, 0))
prof_panel_filter$any_online_news_l <- as.factor(ifelse(prof_panel_filter$alt_online_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_gen <- as.factor(ifelse(prof_panel_filter$alt_online_general_all > 0, 1, 0))
prof_panel_filter$any_online_news_gen_l <- as.factor(ifelse(prof_panel_filter$alt_online_general_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_name <- as.factor(ifelse(prof_panel_filter$alt_online_name_all > 0, 1, 0))
prof_panel_filter$any_online_news_name_l <- as.factor(ifelse(prof_panel_filter$alt_online_name_all_l > 0, 1, 0))

prof_panel_filter$any_twitter <- as.factor(ifelse(prof_panel_filter$alt_twitter > 0, 1, 0))
prof_panel_filter$any_twitter_l <- as.factor(ifelse(prof_panel_filter$alt_twitter_l > 0, 1, 0))
```

Binary variables for belonging to the top 10/20% in the attention for each source.
```{r}
panel_filter_long <- prof_panel_filter %>%
  pivot_longer(c(alt_online_all, alt_online_name_all, news_all, alt_twitter), names_to = "measure", values_to = "value")

top_10_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.90, na.rm = TRUE)<value)%>%
  select(profile_id, general_field, year, measure, value)

top_10_attn$measure <- paste0(top_10_attn$measure, "_top_10")


top_10_attn <- top_10_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_10'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_10_attn[c("year", "profile_id", "general_field", "alt_online_all_top_10", "alt_online_name_all_top_10", "alt_twitter_top_10", "news_all_top_10")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

top_20_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.80, na.rm = TRUE)<value)%>%
  select(profile_id, general_field, year, measure, value)

top_20_attn$measure <- paste0(top_20_attn$measure, "_top_20")


top_20_attn <- top_20_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_20'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_20_attn[c("year", "profile_id", "general_field", "alt_online_all_top_20", "alt_online_name_all_top_20", "alt_twitter_top_20", "news_all_top_20")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

prof_panel_filter <- filter(prof_panel_filter, !is.na(general_field))
```

Split datasets per field:
```{r}
stem <- filter(prof_panel_filter, general_field == "STEM")
soc_sci <- filter(prof_panel_filter, general_field == "Social sciences")
arts <- filter(prof_panel_filter, general_field == "Arts & Humanities")
medicine <- filter(prof_panel_filter, general_field == "Medicine")
```


## Count models

### News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- lm(news_all ~ # professor publication variables
                     news_all_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset) 
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_models_news <- rbind(all_models_news,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)
  
  
}

all_models_news$stars <- ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)

all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
news_gender_plot <- all_predictions_news %>%
   ggplot(aes(x = fct_rev(field),
              y = predicted,
              ymin = conf.low,
              ymax = conf.high,
              color = x)) +
   geom_pointrange(position = position_dodge(width = 0.5),
                   size = 0.5)+
   ggtitle("(a) Predicted values of news attention")+
     stat_pvalue_manual(
    all_comparisons_news,
    y.position = c(4.6, 4.6, 4, 4),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
    )+
    xlab("Field")+
   scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social science",
                             "stem" = "STEM"))+
   ylab("News attention per year")+
   labs(color = "Inferred gender")+
   scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
   theme_minimal_hgrid()+
   theme(plot.title = element_text(size = 8),
         axis.text.y = element_text(size = 8),
         axis.title.y = element_text(size = 10),
         axis.text.x = element_text(size = 8) ,
         axis.title.x = element_text(size = 10),
         legend.title=element_text(size=8), 
         legend.text=element_text(size=7))
```

```{r}
knitr::kable(all_models_news)
```


### Online News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- lm(alt_online_all ~ # professor publication variables
                         alt_online_all_l+
                         cited_by_total_all_l + 
                         # gender
                         inferred_gender  +
                         # attention variables
                         news_all_total_l + alt_twitter_total_l +
                         # coauthor publication variables
                         coa_tot_cited_by_total_l +
                         # coauthor publication variables
                         coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset) 
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                           gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                           prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_online_news$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_online_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
online_news_gender_plot <- all_predictions_online_news %>%
   ggplot(aes(x = fct_rev(field),
              y = predicted,
              ymin = conf.low,
              ymax = conf.high,
              color = x)) +
   geom_pointrange(position = position_dodge(width = 0.5),
                   size = 0.5)+
   #ylim(2, 5.5)+
   ggtitle("(b) Predicted values of online news attention")+
     stat_pvalue_manual(
    all_comparisons_online_news,
    y.position = c(7, 7, 4, 4),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
    )+
    xlab("Field")+
   scale_x_discrete()+
   scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social science",
                             "stem" = "STEM"))+
   ylab("Online news attention per year")+
   labs(color = "Inferred gender")+
   scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
   theme_minimal_hgrid()+
   theme(plot.title = element_text(size = 8),
         axis.text.y = element_text(size = 8),
         axis.title.y = element_text(size = 10),
         axis.text.x = element_text(size = 8) ,
         axis.title.x = element_text(size = 10),
         legend.title=element_text(size=8), 
         legend.text=element_text(size=7))
```

```{r}
knitr::kable(all_models_online_news)
```


### Twitter
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- lm(alt_twitter ~ # professor publication variables
                     alt_twitter_l + 
                     count_pubs_total_l + cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset) 
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
twitter_gender_plot <- all_predictions_twitter %>%
   ggplot(aes(x = fct_rev(field),
              y = predicted,
              ymin = conf.low,
              ymax = conf.high,
              color = x)) +
   geom_pointrange(position = position_dodge(width = 0.5),
                   size = 0.5)+
   #ylim(2, 5.5)+
   ggtitle("(c) Predicted values of Twitter attention")+
     stat_pvalue_manual(
    all_comparisons_twitter,
    y.position = c(0, 26, 0, 10),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
    )+
    xlab("Field")+
   scale_x_discrete()+
   scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social science",
                             "stem" = "STEM"))+
   ylab("News attention per year")+
   labs(color = "Inferred gender")+
   scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
   theme_minimal_hgrid()+
   theme(plot.title = element_text(size = 8),
         axis.text.y = element_text(size = 8),
         axis.title.y = element_text(size = 10),
         axis.text.x = element_text(size = 8) ,
         axis.title.x = element_text(size = 10),
         legend.title=element_text(size=8), 
         legend.text=element_text(size=7))
```

```{r}
knitr::kable(all_models_twitter)
```


### Write out the models
```{r}
write_csv(all_models_news, "Plots_april/reg_mod_ols_news.csv")
write_csv(all_models_online_news, "Plots_april/reg_mod_ols_online_news.csv")
write_csv(all_models_twitter, "Plots_april/reg_mod_ols_twitter.csv")
```


### Combine the plots

Plot it all together:
```{r fig.width=11, fig.height=3}
legend <- get_legend(
  # create some space to the left of the legend
  news_gender_plot
)

combi_plot <- cowplot::plot_grid(news_gender_plot + theme(legend.position="none"), 
                    online_news_gender_plot + theme(legend.position="none"),
                    twitter_gender_plot + theme(legend.position="none"),
                    legend,
                    ncol = 4,
                    rel_widths = c(1, 1, 1, 0.3))

combi_plot
ggsave2(
  filename = "Plots_april/Plot_2_counts.png",
  plot = combi_plot,
  width = 11,
  height = 3,
  units = c("in"),
  dpi = 600,
  bg = "white"
)
```





## Count models - Poisson

### News

Check how many zeroes do we have:
```{r}
100*sum(prof_panel_filter$news == 0)/nrow(prof_panel_filter)
```
Almost 70%!

This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_count_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_count_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_count_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(news_all ~ # professor publication variables
                     news_all_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'poisson') 
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  # model_result[nrow(model_result)+1, 1] <- "R^2"
  # model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_count_models_news <- rbind(all_count_models_news,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_count_comparisons_news <- rbind(all_count_comparisons_news,
                           gender_comparison)
  
  all_count_predictions_news <- rbind(all_count_predictions_news,
                           prediction)
  
  
}

all_count_models_news$stars <- ifelse(all_count_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_count_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_count_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_count_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_count_comparisons_news$stars <- ifelse(all_count_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_count_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_count_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_count_comparisons_news$`p.value` <= 0.1, ".", ""))))

all_count_comparisons_news$group1 <- str_split_i(all_count_comparisons_news$inferred_gender, "-", 1)
all_count_comparisons_news$group2 <- str_split_i(all_count_comparisons_news$inferred_gender, "-", 2)

all_count_comparisons_news$p_rounded <- round(all_count_comparisons_news$p.value, 4)
```

```{r}
knitr::kable(all_count_models_news)
```

### Online News

Check how many zeroes do we have:
```{r}
100*sum(prof_panel_filter$alt_online_all == 0, na.rm = TRUE)/nrow(prof_panel_filter)
```
Around 27%.

This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_count_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_count_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_count_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(alt_online_all ~ # professor publication variables
                         alt_online_all_l+
                         cited_by_total_all_l + 
                         # gender
                         inferred_gender  +
                         # attention variables
                         news_all_total_l + alt_twitter_total_l +
                         # coauthor publication variables
                         coa_tot_cited_by_total_l +
                         # coauthor publication variables
                         coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'poisson')  
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  # model_result[nrow(model_result)+1, 1] <- "R^2"
  # model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_count_models_online_news <- rbind(all_count_models_online_news,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_count_comparisons_online_news <- rbind(all_count_comparisons_online_news,
                           gender_comparison)
  
  all_count_predictions_online_news <- rbind(all_count_predictions_online_news,
                           prediction)
  
  
}

all_count_models_online_news$stars <- ifelse(all_count_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_count_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_count_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_count_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_count_comparisons_online_news$stars <- ifelse(all_count_comparisons_online_news$`p.value` <= 0.001, "***",
                           ifelse(all_count_comparisons_online_news$`p.value` <= 0.001, "**",
                                  ifelse(all_count_comparisons_online_news$`p.value` <= 0.05, "*",
                                         ifelse(all_count_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_count_comparisons_online_news$group1 <- str_split_i(all_count_comparisons_online_news$inferred_gender, "-", 1)
all_count_comparisons_online_news$group2 <- str_split_i(all_count_comparisons_online_news$inferred_gender, "-", 2)

all_count_comparisons_online_news$p_rounded <- round(all_count_comparisons_online_news$p.value, 4)
```

```{r}
knitr::kable(all_count_models_online_news)
```


### Twitter

Check how many zeroes do we have:
```{r}
100*sum(prof_panel_filter$alt_twitter == 0, na.rm = TRUE)/nrow(prof_panel_filter)
```

This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_count_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_count_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_count_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(alt_twitter ~ # professor publication variables
                     alt_twitter_l +  cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'poisson')
  
  model_result <- coeftest(news_model, vcov = vcovCL, cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  # model_result[nrow(model_result)+1, 1] <- "R^2"
  # model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(news_model)$r.squared,3)
  model_result$field <- field
  
  all_count_models_twitter <- rbind(all_count_models_twitter,
                      model_result)
  
  prediction <- predict_response(news_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_count_comparisons_twitter <- rbind(all_count_comparisons_twitter,
                           gender_comparison)
  
  all_count_predictions_twitter <- rbind(all_count_predictions_twitter,
                           prediction)
  
  
}

all_count_models_twitter$stars <- ifelse(all_count_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_count_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_count_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_count_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_count_comparisons_twitter$stars <- ifelse(all_count_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_count_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_count_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_count_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_count_comparisons_twitter$group1 <- str_split_i(all_count_comparisons_twitter$inferred_gender, "-", 1)
all_count_comparisons_twitter$group2 <- str_split_i(all_count_comparisons_twitter$inferred_gender, "-", 2)

all_count_comparisons_twitter$p_rounded <- round(all_count_comparisons_twitter$p.value, 4)


```

```{r}
knitr::kable(all_count_models_twitter)
```


### Write out the models
```{r}
write_csv(all_count_models_news, "Plots_april/reg_mod_poisson_news.csv")
write_csv(all_count_models_online_news, "Plots_april/reg_mod_poisson_online_news.csv")
write_csv(all_count_models_twitter, "Plots_april/reg_mod_poisson_twitter.csv")
```


## Binary models - any attention

### News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(any_news ~ # professor publication variables
                     news_all_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial') 
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin_models_news <- rbind(all_bin_models_news,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "HC0")
  gender_comparison$field <- field
  
  all_bin_comparisons_news <- rbind(all_bin_comparisons_news,
                           gender_comparison)
  
  
}

all_bin_models_news$stars <- ifelse(all_bin_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin_comparisons_news$stars <- ifelse(all_bin_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_bin_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_bin_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_bin_comparisons_news$`p.value` <= 0.1, ".", ""))))

all_bin_comparisons_news$group1 <- str_split_i(all_bin_comparisons_news$inferred_gender, "-", 1)
all_bin_comparisons_news$group2 <- str_split_i(all_bin_comparisons_news$inferred_gender, "-", 2)

all_bin_comparisons_news$p_rounded <- round(all_bin_comparisons_news$p.value, 4)

```

```{r}
knitr::kable(all_bin_models_news)
```

### Online News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(any_online_news ~ # professor publication variables
                         alt_online_all_l+
                         cited_by_total_all_l + 
                         # gender
                         inferred_gender  +
                         # attention variables
                         news_all_total_l + alt_twitter_total_l +
                         # coauthor publication variables
                         coa_tot_cited_by_total_l +
                         # coauthor publication variables
                         coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial')  
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin_models_online_news <- rbind(all_bin_models_online_news,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_bin_comparisons_online_news <- rbind(all_bin_comparisons_online_news,
                           gender_comparison)
  
  
}

all_bin_models_online_news$stars <- ifelse(all_bin_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin_comparisons_online_news$stars <- ifelse(all_bin_comparisons_online_news$`p.value` <= 0.001, "***",
                           ifelse(all_bin_comparisons_online_news$`p.value` <= 0.001, "**",
                                  ifelse(all_bin_comparisons_online_news$`p.value` <= 0.05, "*",
                                         ifelse(all_bin_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_bin_comparisons_online_news$group1 <- str_split_i(all_bin_comparisons_online_news$inferred_gender, "-", 1)
all_bin_comparisons_online_news$group2 <- str_split_i(all_bin_comparisons_online_news$inferred_gender, "-", 2)

all_bin_comparisons_online_news$p_rounded <- round(all_bin_comparisons_online_news$p.value, 4)

```

```{r}
knitr::kable(all_bin_models_online_news)
```


### Twitter
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_bin_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(any_twitter ~ # professor publication variables
                     alt_twitter_l +  cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial')
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin_models_twitter <- rbind(all_bin_models_twitter,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_bin_comparisons_twitter <- rbind(all_bin_comparisons_twitter,
                           gender_comparison)
  
  
}

all_bin_models_twitter$stars <- ifelse(all_bin_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin_comparisons_twitter$stars <- ifelse(all_bin_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_bin_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_bin_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_bin_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_bin_comparisons_twitter$group1 <- str_split_i(all_bin_comparisons_twitter$inferred_gender, "-", 1)
all_bin_comparisons_twitter$group2 <- str_split_i(all_bin_comparisons_twitter$inferred_gender, "-", 2)

all_bin_comparisons_twitter$p_rounded <- round(all_bin_comparisons_twitter$p.value, 4)
```

```{r}
knitr::kable(all_bin_models_twitter)
```


### Write out the models
```{r}
write_csv(all_bin_models_news, "Plots_april/reg_mod_bin_news.csv")
write_csv(all_bin_models_online_news, "Plots_april/reg_mod_bin_online_news.csv")
write_csv(all_bin_models_twitter, "Plots_april/reg_mod_bin_twitter.csv")
```


## Binary models - top 10

### News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin10_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin10_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(news_all_top_10 ~ # professor publication variables
                     news_all_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial') 
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin10_models_news <- rbind(all_bin10_models_news,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "HC0")
  gender_comparison$field <- field
  
  all_bin10_comparisons_news <- rbind(all_bin10_comparisons_news,
                           gender_comparison)
  
  
}

all_bin10_models_news$stars <- ifelse(all_bin10_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin10_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin10_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin10_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin10_comparisons_news$stars <- ifelse(all_bin10_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_bin10_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_bin10_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_bin10_comparisons_news$`p.value` <= 0.1, ".", ""))))

all_bin10_comparisons_news$group1 <- str_split_i(all_bin10_comparisons_news$inferred_gender, "-", 1)
all_bin10_comparisons_news$group2 <- str_split_i(all_bin10_comparisons_news$inferred_gender, "-", 2)

all_bin10_comparisons_news$p_rounded <- round(all_bin10_comparisons_news$p.value, 4)

```

```{r}
knitr::kable(all_bin10_models_news)
```

### Online News
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin10_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin10_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(alt_online_all_top_10 ~ # professor publication variables
                         alt_online_all_l+
                         cited_by_total_all_l + 
                         # gender
                         inferred_gender  +
                         # attention variables
                         news_all_total_l + alt_twitter_total_l +
                         # coauthor publication variables
                         coa_tot_cited_by_total_l +
                         # coauthor publication variables
                         coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial')  
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin10_models_online_news <- rbind(all_bin10_models_online_news,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_bin10_comparisons_online_news <- rbind(all_bin10_comparisons_online_news,
                           gender_comparison)
  
  
}

all_bin10_models_online_news$stars <- ifelse(all_bin10_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin10_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin10_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin10_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin10_comparisons_online_news$stars <- ifelse(all_bin10_comparisons_online_news$`p.value` <= 0.001, "***",
                           ifelse(all_bin10_comparisons_online_news$`p.value` <= 0.001, "**",
                                  ifelse(all_bin10_comparisons_online_news$`p.value` <= 0.05, "*",
                                         ifelse(all_bin10_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_bin10_comparisons_online_news$group1 <- str_split_i(all_bin10_comparisons_online_news$inferred_gender, "-", 1)
all_bin10_comparisons_online_news$group2 <- str_split_i(all_bin10_comparisons_online_news$inferred_gender, "-", 2)

all_bin10_comparisons_online_news$p_rounded <- round(all_bin10_comparisons_online_news$p.value, 4)

```

```{r}
knitr::kable(all_bin10_models_online_news)
```

### Twitter
This time period's news given one's total citations/publications, past total 
attention, controlling for the field and year (Lexis sample only). Pooled model
with clustered SEs:
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_bin10_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_bin10_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  news_model <- glm(alt_twitter_top_10 ~ # professor publication variables
                     alt_twitter_l +  cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_news_total_l + coa_twitter_total_l+as.factor(year),
                   data = field_dataset, family = 'binomial')
  
  model_result <- coeftest(news_model, type = "HC0", cluster = ~profile_id)[,] %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column(var = "term")
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(news_model),3)
  model_result$field <- field
  
  all_bin10_models_twitter <- rbind(all_bin10_models_twitter,
                      model_result)
  
  gender_comparison <- test_predictions(news_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_bin10_comparisons_twitter <- rbind(all_bin10_comparisons_twitter,
                           gender_comparison)
  
  
}

all_bin10_models_twitter$stars <- ifelse(all_bin10_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_bin10_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_bin10_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_bin10_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_bin10_comparisons_twitter$stars <- ifelse(all_bin10_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_bin10_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_bin10_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_bin10_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_bin10_comparisons_twitter$group1 <- str_split_i(all_bin10_comparisons_twitter$inferred_gender, "-", 1)
all_bin10_comparisons_twitter$group2 <- str_split_i(all_bin10_comparisons_twitter$inferred_gender, "-", 2)

all_bin10_comparisons_twitter$p_rounded <- round(all_bin10_comparisons_twitter$p.value, 4)
```
## Write out the models
```{r}
write_csv(all_bin10_models_news, "Plots_april/reg_mod_bin10_news.csv")
write_csv(all_bin10_models_online_news, "Plots_april/reg_mod_bin10_online_news.csv")
write_csv(all_bin10_models_twitter, "Plots_april/reg_mod_bin10_twitter.csv")
```

```{r}
knitr::kable(all_bin10_models_twitter)
```

# Mobility per gender

Let us look only at people who have entered the dataset before 2012 and limit the 
dataset to the period after 2012:
```{r}
prof_panel_mobility <- filter(prof_panel_filter, first_pub <= 2012 & year >= 2012)

# split the periods into 2
prof_panel_mobility$period <- ifelse(prof_panel_mobility$year <= 2017, "first", "second")
```

Now, select professors' attention in these years and add it up per period:

Get transition matrices per gender:
(see the "helper_functions.R" file for the actual function)
```{r message=F}
splits <- 10

gender_matrices <- gen_transition_matrix(prof_panel_mobility, split_by = "gender", brackets = splits)
```

Get transition matrices per gender and field:
```{r message=F}
gender_field_matrices <- gen_transition_matrix(prof_panel_mobility, split_by = "gender & field", brackets = splits)
```

Get plots for:
### Overall transitions:
```{r}
loop_list <- c("pub_transitions", "cit_transitions",
          "online_news_transitions", "news_transitions", 
          "twitter_transitions")

titles <- c("Publications", "Citations",
            "Online news attention", "News attention",
            "Twitter attention")


color_list <- c("#fb923c", "#fbbf24", "#34d399", "#22d3ee", "#818cf8")

overall_transition_plots <- list()

for (matrix in loop_list){
  matrix_current <- gender_matrices[[matrix]][["all"]]
  
  plot_current <- matrix_current %>% 
    as.data.frame() %>%
    rownames_to_column("p1") %>%
    pivot_longer(-c(p1), names_to = "p2", values_to = "prob")%>%
    ggplot(aes(x=as.integer(p1), y=as.integer(p2), fill=prob)) + 
    geom_tile() +
    scale_fill_gradient2(low = "#f87171", mid = "white", high = color_list[which(loop_list == matrix)])+
    scale_x_continuous(breaks=seq(0, splits, 1), expand = c(0, 0))+
    scale_y_continuous(breaks=seq(0, splits, 1), trans = "reverse", expand = c(0, 0))+
    xlab("Period 1: 2011-2017")+
    ylab("Period 2: 2018-2023")+
    theme_minimal()+
    ggtitle(titles[which(loop_list == matrix)])+
    guides(fill=guide_legend(title="Probability"))+
    theme(plot.title = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=10), 
          legend.text=element_text(size=8))
  
  overall_transition_plots[[matrix]] <- plot_current
  
}
```
Plot these:
```{r fig.width=8, fig.height=7}
grid.arrange(grobs = overall_transition_plots, ncol = 2)
```

### Overall transitions per field:
```{r}
loop_list <- c("pub_transitions", "cit_transitions",
          "online_news_transitions", "news_transitions", 
          "twitter_transitions")

titles <- c("Publications", "Citations",
            "Online news attention", "News attention",
            "Twitter attention")


color_list <- c("#fb923c", "#fbbf24", "#34d399", "#22d3ee", "#818cf8")

overall_field_transition_plots <- list()

for (matrix in loop_list){
  fields <- c("STEM", "Social sciences", "Medicine", "Arts & Humanities")
  
  for (field in fields){
  matrix_current <- gender_field_matrices[[matrix]][[field]][["all"]]
  
  plot_current <- matrix_current %>% 
    as.data.frame() %>%
    rownames_to_column("p1") %>%
    pivot_longer(-c(p1), names_to = "p2", values_to = "prob")%>%
    ggplot(aes(x=as.integer(p1), y=as.integer(p2), fill=prob)) + 
    geom_tile() +
    scale_fill_gradient2(low = "#f87171", mid = "white", high = color_list[which(loop_list == matrix)])+
    scale_x_continuous(breaks=seq(0, splits, 1), expand = c(0, 0))+
    scale_y_continuous(breaks=seq(0, splits, 1), trans = "reverse", expand = c(0, 0))+
    xlab("Period 1: 2011-2017")+
    ylab("Period 2: 2018-2023")+
    theme_minimal()+
    ggtitle(titles[which(loop_list == matrix)])+
    guides(fill=guide_legend(title="Probability"))+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 9),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 9) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=10), 
        legend.text=element_text(size=8))
  
  overall_field_transition_plots[[field]][[matrix]] <- plot_current
  
  }
  
}
```

Prepare transition plots per field:
```{r fig.width=12, fig.height=12}
plot1 <- overall_field_transition_plots[['STEM']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots[['STEM']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots[['STEM']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

# now add the title
title <- ggdraw() + 
  draw_label(
    "(a) STEM",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
stem <- plot_grid(plot1,
                  plot2,
                  plot3, ncol = 3, nrow = 1)

stem <- plot_grid(
  title, stem,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots[['Social sciences']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots[['Social sciences']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots[['Social sciences']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

soc_sci <- plot_grid(plot1,
                     plot2,
                     plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(b) Social science",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

soc_sci <- plot_grid(
  title, soc_sci,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots[['Medicine']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots[['Medicine']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots[['Medicine']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

medicine <- plot_grid(plot1,
          plot2,
          plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(c) Medicine",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

medicine <- plot_grid(
  title, medicine,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots[['Arts & Humanities']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots[['Arts & Humanities']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots[['Arts & Humanities']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

arts_hum <- plot_grid(plot1,
          plot2,
          plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(d) Arts & Humanities",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

arts_hum <- plot_grid(
  title, arts_hum,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

```

Save the plot:
```{r fig.width=10, fig.height=10}
ggsave(file="Plots_april/Supplemental/P_overall_transitions.png", 
       grid.arrange(stem, soc_sci,
                    medicine, arts_hum,
                    ncol = 1, nrow = 4),
       width = 10,
       height = 10,
       units = "in")
```

### Differences in transitions:
```{r}
loop_list <- c("online_news_transitions", "news_transitions", 
          "twitter_transitions")

titles <- c("Online news attention", "News attention",
            "Twitter attention")


color_list <- c("#fb923c", "#fbbf24", "#34d399", "#22d3ee", "#818cf8")
color_list2 <- c("#fff7ed", "#fffbeb", "#ecfdf5", "#ecfeff", "#eef2ff")

overall_diff_plots <- list()

for (matrix in loop_list){
  matrix_current_men <- gender_matrices[[matrix]][["men"]]
  matrix_current_women <- gender_matrices[[matrix]][["women"]]
  matrix_diff <- matrix_current_women - matrix_current_men
  plot_current <- matrix_diff %>% 
    as.data.frame() %>%
    rownames_to_column("p1") %>%
    pivot_longer(-c(p1), names_to = "p2", values_to = "prob")%>%
    ggplot(aes(x=as.integer(p1), y=as.integer(p2), fill=prob)) + 
    geom_tile() +
    scale_fill_gradient2(low = "#f87171", mid = "white", high = color_list[which(loop_list == matrix)])+
    scale_x_continuous(breaks=seq(0, splits, 1), expand = c(0, 0))+
    scale_y_continuous(breaks=seq(0, splits, 1), trans = "reverse", expand = c(0, 0))+
    xlab("p_1")+
    ylab("p_2")+
    theme_minimal()+
    ggtitle(titles[which(loop_list == matrix)])+
    guides(fill=guide_legend(title="Diff. (w - m)"))
  
  overall_diff_plots[[matrix]] <- plot_current
  
}
```

Plot these:
```{r fig.width=12, fig.height=3}
grid.arrange(grobs = overall_diff_plots, ncol = 3)
```

Differences per field:
```{r}
loop_list <- c("pub_transitions", "cit_transitions",
          "online_news_transitions", "news_transitions", 
          "twitter_transitions")

titles <- c("Publications", "Citations",
            "Online news attention", "News attention",
            "Twitter attention")


color_list <- c("#fb923c", "#fbbf24", "#34d399", "#22d3ee", "#818cf8")

overall_field_transition_plots_diff <- list()

for (matrix in loop_list){
  fields <- c("STEM", "Social sciences", "Medicine", "Arts & Humanities")
  
  for (field in fields){
  matrix_current_men <- gender_field_matrices[[matrix]][[field]][["men"]]
  matrix_current_women <- gender_field_matrices[[matrix]][[field]][["women"]]
  matrix_diff <- matrix_current_women - matrix_current_men
  
  plot_current <- matrix_diff %>% 
    as.data.frame() %>%
    rownames_to_column("p1") %>%
    pivot_longer(-c(p1), names_to = "p2", values_to = "prob")%>%
    ggplot(aes(x=as.integer(p1), y=as.integer(p2), fill=prob)) + 
    geom_tile() +
    scale_fill_gradient2(low = "#f87171", mid = "white", high = color_list[which(loop_list == matrix)], limits=c(-0.4, 0.4), breaks=seq(round(-0.4, 1),round(0.4,1),by=0.2))+
    scale_x_continuous(breaks=seq(0, splits, 1), expand = c(0, 0))+
    scale_y_continuous(breaks=seq(0, splits, 1), trans = "reverse", expand = c(0, 0))+
    xlab("Period 1: 2011-2017")+
    ylab("Period 2: 2018-2023")+
    theme_minimal()+
    ggtitle(titles[which(loop_list == matrix)])+
    guides(fill=guide_legend(title="Prob. diff. (w-m)"))+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 9),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 9) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=10), 
        legend.text=element_text(size=8))
  
  overall_field_transition_plots_diff[[field]][[matrix]] <- plot_current
  
  }
  
}
```

Prepare transition difference plots per field:
```{r fig.width=12, fig.height=12}
plot1 <- overall_field_transition_plots_diff[['STEM']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots_diff[['STEM']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots_diff[['STEM']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

# now add the title
title <- ggdraw() + 
  draw_label(
    "(a) STEM",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
stem <- plot_grid(plot1,
                  plot2,
                  plot3, ncol = 3, nrow = 1)

stem <- plot_grid(
  title, stem,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots_diff[['Social sciences']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots_diff[['Social sciences']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots_diff[['Social sciences']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

soc_sci <- plot_grid(plot1,
                     plot2,
                     plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(b) Social science",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

soc_sci <- plot_grid(
  title, soc_sci,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots_diff[['Medicine']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots_diff[['Medicine']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots_diff[['Medicine']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

medicine <- plot_grid(plot1,
          plot2,
          plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(c) Medicine",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

medicine <- plot_grid(
  title, medicine,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

plot1 <- overall_field_transition_plots_diff[['Arts & Humanities']][4][["news_transitions"]]+ggtitle("(i) News attention")
plot2 <- overall_field_transition_plots_diff[['Arts & Humanities']][3][["online_news_transitions"]]+ggtitle("(ii) Online attention")
plot3 <- overall_field_transition_plots_diff[['Arts & Humanities']][5][["twitter_transitions"]]+ggtitle("(iii) Twitter attention")

arts_hum <- plot_grid(plot1,
          plot2,
          plot3, ncol = 3, nrow = 1)

title <- ggdraw() + 
  draw_label(
    "(d) Arts & Humanities",
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

arts_hum <- plot_grid(
  title, arts_hum,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

```

Save the plot:
```{r fig.width=10, fig.height=10}
ggsave(file="Plots_april/Supplemental/P_transition_diff.png", 
       grid.arrange(stem, soc_sci,
                    medicine, arts_hum,
                    ncol = 1, nrow = 4),
       width = 10,
       height = 10,
       units = "in")
```
