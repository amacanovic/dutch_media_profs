---
title: "Various analyses - May 2024, final dataset"
author: "Ana Macanovic"
date: "2024-05-15"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```


Load the packages:
```{r message=  F, warning = F, eval = T}
library(groundhog)
packages_to_load <- c("readr", "dplyr", "tidyr", 
                      "ggplot2", "gridExtra", "cowplot",
                      "tidyverse", "RPostgres", "markovchain"
                      , "RPostgres", "lubridate", "psych",
                      "gridExtra", "DescTools", "marginaleffects",
                      "panelr", "skimr", "margins", "Hmisc",
                      "lmtest", "sandwich", "rstatix", "ggpubr", "knitr",
                      "scales",
                      "stargazer","plm", "grid", "corrplot", "ggeffects", 
                      "insight", "broom", "dineq", "lemon", "gglorenz")

groundhog.library(packages_to_load, date = "2024-4-23")

# install.packages("insight")
# 
# library(insight)
# install.packages("ggeffects")
# library(ggeffects)
source("helper_functions.R")
```

Load the panel and tidy up some columns:
```{r warning = F, message = F}
prof_panel_coa <- read_csv("panel_datasets/prof_panel_tidy_1_5.csv")

prof_panel_filter <- filter(prof_panel_coa,
                            year < 2024 & !is.na(general_field))

prof_panel_filter$coa_online_all_total <- prof_panel_filter$coa_online_news_total + prof_panel_filter$coa_blogs_total
prof_panel_filter$coa_online_all_total_l <- prof_panel_filter$coa_online_news_total_l + prof_panel_filter$coa_blogs_total_l
prof_panel_filter$coa_online_all <- prof_panel_filter$coa_online_news + prof_panel_filter$coa_blogs
prof_panel_filter$coa_online_all_l <- prof_panel_filter$coa_online_news_l + prof_panel_filter$coa_blogs_l

prof_panel_filter$coa_tot_online_all_total <- prof_panel_filter$coa_tot_online_news_total + prof_panel_filter$coa_tot_blogs_total
prof_panel_filter$coa_tot_online_all_total_l <- prof_panel_filter$coa_tot_online_news_total_l + prof_panel_filter$coa_tot_blogs_total_l
prof_panel_filter$coa_tot_online_all <- prof_panel_filter$coa_tot_online_news + prof_panel_filter$coa_tot_blogs
prof_panel_filter$coa_tot_online_all_l <- prof_panel_filter$coa_tot_online_news + prof_panel_filter$coa_tot_blogs_l
```

# Correlations

```{r}
sources_check <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))
```

Check two kinds of coauthor variables we have:
```{r}
select_vars_cor <- c("coa_count_pubs_total_oa",
                     "coa_cited_by_total_oa",
                     "coa_online_all_total",
                     "coa_twitter_total",
                     "coa_tot_count_pubs",
                     "coa_tot_cited_by",
                     "coa_tot_online_all_total",
                     "coa_tot_twitter")

labels_cor <-c("Publications - this year's coauthors' total",
               "Citations - this year's coauthors' total",
               "Online news attention - this year's coauthor' total",
               "Twitter attention - this year's coauthor' total",
               "Publications - all coauthors' total",
               "Citations - all coauthors' total",
               "Online news attention - all coauthor' total",
               "Twitter attention - all coauthor' total")

correlation_matrix <- cor(sources_check[,select_vars_cor],use="pairwise.complete.obs")

colnames(correlation_matrix) <- labels_cor
rownames(correlation_matrix) <- labels_cor


png(height=10, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/correlations/correlations_coauthor_var_comparison_total.png")

# Your function to plot image goes here
corrplot(correlation_matrix, 
         method="number",
         tl.col = "black",
         title = "Variable Correlation Matrix - Coauthor variable comparison (Totals)",
         mar=c(0,0,2,0))
# Then
dev.off()
```

First, some correlations between different variables, looking at totals in the final
year overall:
```{r fig.width=10, fig.height=10}
select_vars_cor <- c("count_pubs_total",
                     "cited_by_total_all",
                     "news_all_total",
                     "alt_online_all_total",
                     "alt_twitter_total",
                     "coa_count_pubs_total_oa",
                     "coa_cited_by_total_oa",
                     "coa_online_all_total",
                     "coa_twitter_total",
                     "years_since_first_pub")

labels_cor <-c("Publications",
               "Citations",
               "News attention",
               "Online news attention",
               "Twitter attention",
               "Coauthor publications",
               "Coauthor citations",
               "Coauthor online news attention",
               "Coauthor twitter attention",
               "Years since first publication")

correlation_matrix <- cor(sources_check[,select_vars_cor],use="pairwise.complete.obs")


colnames(correlation_matrix) <- labels_cor
rownames(correlation_matrix) <- labels_cor


png(height=10, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/correlations/correlations_total_overall.png")

# Your function to plot image goes here
corrplot(correlation_matrix, 
         method="number",
         tl.col = "black",
         title = "Variable Correlation Matrix - Totals, All fields",
         mar=c(0,0,2,0))
# Then
dev.off()

```
And per field:
```{r}
fields <- unique(sources_check$general_field)
fields <- fields[1:4]

for (field in fields){
  field_data <- filter(sources_check, general_field == field)
  
  correlation_matrix_field <- cor(field_data[,select_vars_cor],use="pairwise.complete.obs")
  
  rownames(correlation_matrix_field) <- colnames(correlation_matrix_field)

  
  colnames(correlation_matrix_field) <- labels_cor
  rownames(correlation_matrix_field) <- labels_cor
  
  
  png(height=10, width=10, 
      unit = "in", 
      res = 600,
      file= paste0("results/suppl/correlations/correlations_total_", field, ".png"))
  
  # Your function to plot image goes here
  corrplot(correlation_matrix_field, 
           method="number",
           tl.col = "black",
           title = paste("Variable Correlation Matrix - Totals", field),
         mar=c(0,0,2,0))
  # Then
  dev.off()

}
```

Looking at year over year numbers:
```{r}
select_vars_cor <- c("count_pubs",
                     "cited_by",
                     "news_all",
                     "alt_online_all",
                     "alt_twitter",
                     "coa_count_pubs",
                     "coa_cited_by",
                     "coa_online_all",
                     "coa_twitter")

correlation_matrix <- cor(prof_panel_filter[,select_vars_cor],use="pairwise.complete.obs")


colnames(correlation_matrix) <- labels_cor[1:9]
rownames(correlation_matrix) <- labels_cor[1:9]


png(height=10, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/correlations/correlations_yearly_overall.png")

# Your function to plot image goes here
corrplot(correlation_matrix, 
         method="number",
         tl.col = "black",
         title = "Variable Correlation Matrix - Yearly, All fields",
         mar=c(0,0,2,0))
# Then
dev.off()
```
And per field:
```{r}
for (field in fields){
  field_data <- filter(prof_panel_filter, general_field == field)
  
  correlation_matrix_field <- cor(field_data[,select_vars_cor],use="pairwise.complete.obs")
  
  rownames(correlation_matrix_field) <- colnames(correlation_matrix_field)

  
  colnames(correlation_matrix_field) <- labels_cor[1:9]
  rownames(correlation_matrix_field) <- labels_cor[1:9]
  
  
  png(height=10, width=10, 
      unit = "in", 
      res = 600,
      file= paste0("results/suppl/correlations/correlations_yearly_", field, ".png"))
  
  # Your function to plot image goes here
  corrplot(correlation_matrix_field, 
           method="number",
           tl.col = "black",
           title = paste("Variable Correlation Matrix - Yearly,", field),
         mar=c(0,0,2,0))
  # Then
  dev.off()

}
```



# Average numbers of mentions and comparison per gender

```{r}
sources_check <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year) & !is.na(overall_field))
```

How many professors have at least one mention?
```{r}
sources_check$any_news <- ifelse(sources_check$news_all_total > 0, TRUE, FALSE)

table(sources_check$any_news)
prop.table(table(sources_check$any_news))
```
96% of professors in our data - 6499 of them, has at least one news mention.

On average, a professor in our dataset has accumulated 68.9 mentions throughout
their career:
```{r}
mean(sources_check$news_all_total, na.rm = TRUE)
```
Or, 23 mentions per year:
```{r}
mean(prof_panel_filter$news_all, na.rm = TRUE)
```

Overall comparison between men and women:
```{r}
overall_comparisons <- data.frame(matrix(NA, ncol = 6, nrow = 1))
i <- 1
overall_comparisons[i, 1] <- "overall"
overall_comparisons[i, 2] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 3] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 4] <- round(wilcox.test(news_all_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 5] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)
overall_comparisons[i, 6] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=sources_check, paired=FALSE)$p.value, 5)

colnames(overall_comparisons) <-  c("field", "pubs_total", "citations_total",
                                 "total", "online_total", "twitter_total")

overall_comparisons$comparison <-  "wilc_test"


mean_values <- sources_check %>%
  group_by(inferred_gender)%>%
  filter(!is.na(general_field))%>%
  summarise(pubs_total = mean(count_pubs_total, na.rm = TRUE),
            citations_total = mean(cited_by_total_all, na.rm = TRUE),
            total = mean(news_all_total, na.rm = TRUE),
            online_total = mean(alt_online_all_total, na.rm = TRUE),
            twitter_total =  mean(alt_twitter_total, na.rm = TRUE))%>%
  mutate(across(2:6, \(x) round(x, 2)))

mean_values$field <- "overall"
colnames(mean_values)[1] <- "comparison"
mean_values <- mean_values[c("comparison", "field", "pubs_total", "citations_total",
                             "total", "online_total", "twitter_total")]

overall_comparisons <- overall_comparisons[c("comparison", "field", "pubs_total", "citations_total",
                                             "total", "online_total", "twitter_total")]

overall_comparisons <- rbind(mean_values,
                             overall_comparisons)

overall_comparisons
```

Within-field comparison:
```{r}
fields <- unique(prof_panel_filter$general_field)
fields <- fields[!is.na(fields)]
field_comparisons <- data.frame(matrix(NA, ncol = 7, nrow = length(fields)))

for (i in 1:length(fields)){
  field <- fields[i]
  data <- filter(sources_check, 
                 general_field == field)
  field_comparisons[i, 1] <- field
  field_comparisons[i, 2] <- nrow(data)
  field_comparisons[i, 3] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 4] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 5] <- round(wilcox.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 6] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
  field_comparisons[i, 7] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
}

colnames(field_comparisons) <- c("field", "profs", "pubs_total", "citations_total",
                                 "total", "online_total", "twitter_total")
field_comparisons$comparison <-  "wilc_test"


mean_values_field <- sources_check %>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender, general_field)%>%
  summarise(pubs_total = mean(count_pubs_total, na.rm = TRUE),
            citations_total = mean(cited_by_total_all, na.rm = TRUE),
            total = mean(news_all_total, na.rm = TRUE),
            online_total = mean(alt_online_all_total, na.rm = TRUE),
            twitter_total =  mean(alt_twitter_total, na.rm = TRUE))%>%
  mutate(across(2:6, \(x) round(x, 2)))

#mean_values_field$field <- "overall"
colnames(mean_values_field)[1] <- "comparison"
colnames(mean_values_field)[2] <- "field"
mean_values_field <- mean_values_field[c("comparison", "field", "pubs_total", "citations_total",
                             "total", "online_total", "twitter_total")]

field_comparisons <- field_comparisons[c("comparison", "field", "pubs_total", "citations_total",
                                             "total", "online_total", "twitter_total")]

field_comparisons <- rbind(mean_values_field,
                           field_comparisons)

field_comparisons <- field_comparisons %>%
  arrange(field)
```

Within-field and year group comparison:
```{r warning = F}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]

year_groups_field_comparisons <- data.frame(matrix(NA, ncol = 8, nrow = length(year_groups)*length(fields)))
row_index <- 0

for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    field <- fields[j]
    data <- filter(sources_check, 
                   years_since_entry == year_group & general_field == field)
    
    women <- filter(data, inferred_gender == "w")
    men <- filter(data, inferred_gender == "m")
    
    if (length(unique(data$inferred_gender)) != 2){
      year_groups_field_comparisons[row_index+j, 1] <- year_group
      year_groups_field_comparisons[row_index+j, 2] <- field
      year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
      year_groups_field_comparisons[row_index+j, 4] <- NA
      year_groups_field_comparisons[row_index+j, 5] <- NA
      year_groups_field_comparisons[row_index+j, 6] <- NA
      year_groups_field_comparisons[row_index+j, 7] <- NA
      year_groups_field_comparisons[row_index+j, 8] <- NA
    }else{
      if (length(which(colSums(data[c("alt_online_all_total", "news_all_total", "alt_twitter_total", "cited_by_total_all", "count_pubs_total")]) == 0)) > 0){
        year_groups_field_comparisons[row_index+j, 1] <- year_group
        year_groups_field_comparisons[row_index+j, 2] <- field
        year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_comparisons[row_index+j, 4] <- NA
        year_groups_field_comparisons[row_index+j, 5] <- NA
        year_groups_field_comparisons[row_index+j, 6] <- NA
        year_groups_field_comparisons[row_index+j, 7] <- NA
        year_groups_field_comparisons[row_index+j, 8] <- NA
        
      }else{
        year_groups_field_comparisons[row_index+j, 1] <- year_group
        year_groups_field_comparisons[row_index+j, 2] <- field
        year_groups_field_comparisons[row_index+j, 3] <- nrow(data)
        year_groups_field_comparisons[row_index+j, 4] <- round(wilcox.test(count_pubs_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 5] <- round(wilcox.test(cited_by_total_all ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 6] <- round(wilcox.test(news_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 7] <- round(wilcox.test(alt_online_all_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
        year_groups_field_comparisons[row_index+j, 8] <- round(wilcox.test(alt_twitter_total ~ inferred_gender, data=data, paired=FALSE)$p.value, 5)
      }
    }
  }
  row_index <- row_index + 4 
}

colnames(year_groups_field_comparisons) <- c("year_group", "field", "profs", "pubs_total", "citations_total",
                                       "total", "online_total", "twitter_total")
year_groups_field_comparisons$comparison <- "wilc_test"

mean_values_year_field <- sources_check %>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender, entry_batch_2023, general_field)%>%
  summarise(pubs_total = mean(count_pubs_total, na.rm = TRUE),
            citations_total = mean(cited_by_total_all, na.rm = TRUE),
            total = mean(news_all_total, na.rm = TRUE),
            online_total = mean(alt_online_all_total, na.rm = TRUE),
            twitter_total =  mean(alt_twitter_total, na.rm = TRUE))%>%
  mutate(across(2:6, \(x) round(x, 2)))

colnames(mean_values_year_field)[1] <- "comparison"
colnames(mean_values_year_field)[2] <- "year_group"
colnames(mean_values_year_field)[3] <- "field"
mean_values_year_field <- mean_values_year_field[c("comparison", "year_group", "field", "pubs_total", "citations_total",
                             "total", "online_total", "twitter_total")]

year_groups_field_comparisons <- year_groups_field_comparisons[c("comparison", "year_group","field", "pubs_total", "citations_total",
                                             "total", "online_total", "twitter_total")]

year_groups_field_comparisons <- rbind(mean_values_year_field,
                           year_groups_field_comparisons)

year_groups_field_comparisons <- year_groups_field_comparisons %>%
  arrange(year_group, field)
```

Rearrange the tables for writing out:
```{r}
overall_comparisons_out <- overall_comparisons %>%
  select(-pubs_total, -citations_total)%>% 
  pivot_wider(
    names_from = comparison,
    values_from = c(total, online_total, twitter_total)
  )%>%
  mutate_at(vars(`online_total_wilc_test`, `total_wilc_test`, `twitter_total_wilc_test`), .funs = list(
    ~case_when(
      . <= 0.001 ~ '***',
      . <= 0.01 ~ '**',
      . <= 0.05 ~ '*',
      . <= 0.1 ~ '*',
      . > 0.1 ~ ''
    )
  ))

field_comparisons_out <- field_comparisons %>%
  select(-pubs_total, -citations_total)%>% 
  pivot_wider(
    names_from = comparison,
    values_from = c(total, online_total, twitter_total)
  )%>%
  mutate_at(vars(`online_total_wilc_test`, `total_wilc_test`, `twitter_total_wilc_test`), .funs = list(
    ~case_when(
      . <= 0.001 ~ '***',
      . <= 0.01 ~ '**',
      . <= 0.05 ~ '*',
      . <= 0.1 ~ '*',
      . > 0.1 ~ ''
    )
  ))

year_groups_field_comparisons_out <- year_groups_field_comparisons %>%
  select(-pubs_total, -citations_total)%>% 
  pivot_wider(
    names_from = comparison,
    values_from = c(total, online_total, twitter_total)
  )%>%
  mutate_at(vars(`online_total_wilc_test`, `total_wilc_test`, `twitter_total_wilc_test`), .funs = list(
    ~case_when(
      . <= 0.001 ~ '***',
      . <= 0.01 ~ '**',
      . <= 0.05 ~ '*',
      . <= 0.1 ~ '*',
      . > 0.1 ~ ''
    )
  ))

## write this out
write_csv(overall_comparisons_out, "results/suppl/avg_comp_overall.csv")
write_csv(field_comparisons_out, "results/suppl/avg_comp_field.csv")
write_csv(year_groups_field_comparisons_out, "results/suppl/avg_comp_year_field.csv")
```


## News source breakdown per field

```{r}
source_breakdown <- sources_check %>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender, general_field)%>%
  summarise(
    n_total = n(),
    intl_total = sum(news_intl_total, na.rm = TRUE),
    national_total = sum(news_national_total, na.rm = TRUE),
    regional_total = sum(news_regional_total, na.rm = TRUE),
    other_total = sum(news_other_total, na.rm = TRUE),
    total_total =  sum(news_all_total, na.rm = TRUE),
    intl_ave = mean(news_intl_total, na.rm = TRUE),
    national_ave = mean(news_national_total, na.rm = TRUE),
    regional_ave = mean(news_regional_total, na.rm = TRUE),
    other_ave = mean(news_other_total, na.rm = TRUE),
    total_ave =  mean(news_all_total, na.rm = TRUE))%>%
  mutate(across(2:6, \(x) round(x, 2)))


source_breakdown$intl_share <- source_breakdown$intl_total/source_breakdown$total_total
source_breakdown$national_share <- source_breakdown$national_total/source_breakdown$total_total
source_breakdown$regional_share <- source_breakdown$regional_total/source_breakdown$total_total
source_breakdown$other_share <- source_breakdown$other_total/source_breakdown$total_total
source_breakdown$total_share <- source_breakdown$total_total/source_breakdown$total_total

source_breakdown_news <- source_breakdown %>%
   pivot_longer(intl_total:total_share, 
               names_to = c('news_type', '.value'),
               names_pattern = '(.*?)_(.*)')%>%
  select(general_field, inferred_gender,news_type, n_total, total:share)%>%
  mutate(across(5:6, \(x) round(x, 2)))%>%
  pivot_wider(
    names_from = inferred_gender,
    values_from = c(n_total:share)
  )

## write this out
write_csv(source_breakdown_news, "results/suppl/source_breakdown_news.csv")
```

## Online news source breakdown per field:
```{r}
source_breakdown <- sources_check %>%
  filter(!is.na(general_field))%>%
  group_by(inferred_gender, general_field)%>%
  summarise(
    n_total = n(),
    gen_total = sum(alt_general_interest_news_total, na.rm = TRUE),
    local_total = sum(alt_general_interest_local_news_total, na.rm = TRUE),
    sci_total = sum(alt_sci_news_aggregator_total, alt_science_news_total, na.rm = TRUE),
    popsci_total = sum(alt_popsci_news_total, na.rm = TRUE),
    blogs_total = sum(alt_online_blog_total, na.rm = TRUE),
    other_total = sum(alt_news_aggregator_total,alt_finance_news_total, alt_medical_news_total, alt_other_news_total, na.rm = TRUE),
    total_total =  sum(alt_online_all_total, na.rm = TRUE),
    gen_ave = mean(alt_general_interest_news_total, na.rm = TRUE),
    local_ave = mean(alt_general_interest_local_news_total, na.rm = TRUE),
    sci_ave = mean(alt_sci_news_aggregator_total+alt_science_news_total, na.rm = TRUE),
    popsci_ave = mean(alt_popsci_news_total, na.rm = TRUE),
    blogs_ave = mean(alt_online_blog_total, na.rm = TRUE),
    other_ave = mean(alt_news_aggregator_total+alt_finance_news_total+alt_medical_news_total+alt_other_news_total, na.rm = TRUE),
    total_ave =  mean(alt_online_all_total, na.rm = TRUE))%>%
  mutate(across(11:16, \(x) round(x, 2)))


source_breakdown$gen_share <- source_breakdown$gen_total/source_breakdown$total_total
source_breakdown$local_share <- source_breakdown$local_total/source_breakdown$total_total
source_breakdown$sci_share <- source_breakdown$sci_total/source_breakdown$total_total
source_breakdown$popsci_share <- source_breakdown$popsci_total/source_breakdown$total_total
source_breakdown$blogs_share <- source_breakdown$blogs_total/source_breakdown$total_total
source_breakdown$other_share <- source_breakdown$other_total/source_breakdown$total_total
source_breakdown$total_share <- source_breakdown$total_total/source_breakdown$total_total

source_breakdown_online_news <- source_breakdown %>%
   pivot_longer(gen_total:total_share, 
               names_to = c('news_type', '.value'),
               names_pattern = '(.*?)_(.*)')%>%
  select(general_field, inferred_gender,news_type, n_total, total:share)%>%
  mutate(across(5:6, \(x) round(x, 2)))%>%
  pivot_wider(
    names_from = inferred_gender,
    values_from = c(n_total:share)
  )

## write this out
write_csv(source_breakdown_online_news, "results/suppl/source_breakdown_online_news.csv")
```
# Women's representation

First, get representation per field in our dataset:
(6791 professors)
```{r}
repr_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))%>%
  filter(!is.na(general_field))%>%
  group_by(general_field, inferred_gender)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)

repr_field_2023$share_women_field <- repr_field_2023$w/(repr_field_2023$m+repr_field_2023$w)

```
## Among top N researchers 
Now get the representation of women among the top 10% and 20% of researchers in terms
of total fame in their field in 2023 (based on their entry batch):
```{r}
# first, get the latest year in the panel for each prof
women_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))

# and now set the final year as 2023, assuming there was no attention after
# whatever the last year is in the dataset (quite some professors with
# 0 mentions even in this last year, so we want to keep them for correct
# shares)
women_field_2023$year <- 2023

# get their decile based on their total performance within their entry batch
women_field_2023 <- women_field_2023 %>%
  filter(!is.na(general_field))%>%
  select(profile_id, year, inferred_gender, general_field, entry_batch_2023, count_pubs_total,
         cited_by_total_all, alt_online_all_total, news_all_total, alt_twitter_total)%>%
  replace(is.na(.), 0)%>%
  group_by(general_field, entry_batch_2023)%>%
  mutate(
         `Publications` = ntile(-count_pubs_total, 20),
         `Citations` = ntile(-cited_by_total_all, 20),    
         `Online news` = ntile(-alt_online_all_total, 20),
         `News` = ntile(-news_all_total, 20),
         `Twitter` = ntile(-alt_twitter_total, 20))
```

Get shares of women among top n% scientists per attention domain:
```{r}
# rearrange the dataset to get counts of women and men in each decile
# then leave only top 10 and 20
share_women_field_2023 <- women_field_2023 %>%
  ungroup()%>%
  select(profile_id, year, inferred_gender, general_field, `Publications`:`Twitter`)%>%
  pivot_longer(`Publications`:`Twitter`)%>%
  group_by(general_field, inferred_gender, name, value)%>%
  summarise(n = n())%>%
  pivot_wider(values_from = n, names_from = inferred_gender)%>%
  group_by(general_field, name)%>%
  mutate(m = cumsum(m),
         w = cumsum(w))%>%
  filter(value %in% c( 2, 4))
 
share_women_field_2023$share_women <- share_women_field_2023$w/(share_women_field_2023$m+share_women_field_2023$w) 
```
Combine the field representation with the attention representation:
```{r}
repr_field_2023$name <- "overall"
repr_field_2023$value <- 0

repr_field_2023 <- repr_field_2023[c(colnames(share_women_field_2023)[1:5],"share_women_field")]

share_women_field_2023 <- merge(share_women_field_2023,
                                repr_field_2023[c("general_field", "share_women_field")],
                                by = "general_field")

share_women_field_2023$share_women_field <- ifelse(share_women_field_2023$name == "News",
                                                   share_women_field_2023$share_women_field,
                                                   NA)
```

Plot this out:

Top 10%:
```{r warning = F}
repr_attn_10 <- share_women_field_2023 %>%
  filter(value == 2 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
  geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(a) top 10% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

repr_attn_20 <- share_women_field_2023 %>%
  filter(value == 4 & name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
    geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("(b) top 20% of attention domains")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))
```


Plot these two next to each other:
```{r fig.width=10, fig.height=4, warning = F}
legend <- get_legend(
  # create some space to the left of the legend
  repr_attn_10
)

combi_plot <- plot_grid(
                    repr_attn_10 + theme(legend.position="none") + ggtitle("(a) top 10% of attention domains"),
                    repr_attn_20 + theme(legend.position="none",
                                        axis.title.y=element_blank(),
                                        axis.text.y=element_blank())+ggtitle("(b) top 20% of attention domains"),
                    legend,
                    ncol = 3,
                    rel_widths = c(1, 0.8, 0.22))


ggsave2(
  filename = "results/main/Plot_1.png",
  plot = combi_plot,
  width = 10,
  height = 4,
  units = c("in"),
  dpi = 300,
  bg = "white"
)

combi_plot
```


## Within total attention

Now get the shares of attention given to women compared to their share in the
field:
```{r}
# first, get the latest year in the panel for each prof
women_field_2023 <- prof_panel_filter %>%
  group_by(profile_id)%>%
  filter(year == max(year))

# and now set the final year as 2023, assuming there was no attention after
# whatever the last year is in the dataset (quite some professors with
# 0 mentions even in this last year, so we want to keep them for correct
# shares)
women_field_2023$year <- 2023

# get their decile based on their total performance within their entry batch
women_field_2023_attn_share <- women_field_2023 %>%
  filter(!is.na(general_field))%>%
  select(profile_id, year, inferred_gender, general_field, count_pubs_total,
         cited_by_total_all, alt_online_all_total, news_all_total, alt_twitter_total)%>%
  replace(is.na(.), 0)%>%
  group_by(general_field)%>%
  summarise(
    pub_w = sum(count_pubs_total[inferred_gender == "w"]),
    cit_w = sum(cited_by_total_all[inferred_gender == "w"]), 
    online_w = sum(alt_online_all_total[inferred_gender == "w"]),
    news_w = sum(news_all_total[inferred_gender == "w"]),
    twitter_w = sum(alt_twitter_total[inferred_gender == "w"]),
    pub = sum(count_pubs_total),
    cit = sum(cited_by_total_all), 
    online = sum(alt_online_all_total),
    news = sum(news_all_total),
    twitter = sum(alt_twitter_total)
  )%>%
  mutate(
         `Publications` = pub_w/pub,
         `Citations` = cit_w/cit,    
         `Online news` = online_w/online,
         `News` = news_w/news,
         `Twitter` = twitter_w/twitter)%>%
  select(general_field, `Publications`:`Twitter`)%>%
  pivot_longer(!general_field, names_to = "name", values_to = "share_women")
```
Combine the field representation with the attention representation:
```{r}
share_women_field_2023_attn_share <- merge(women_field_2023_attn_share,
                                repr_field_2023[c("general_field", "share_women_field")],
                                by = "general_field")

share_women_field_2023_attn_share$share_women_field <- ifelse(share_women_field_2023_attn_share$name == "News",
                                                              share_women_field_2023_attn_share$share_women_field,
                                                              NA)
```

Plot this out:
```{r warning = F}
repr_attn_share <- share_women_field_2023_attn_share %>%
  filter(name %in% c("News", "Online news", "Twitter"))%>%
  ggplot(aes(y=share_women, x=general_field)) + 
  geom_point(aes(shape=name, color=name), position=position_dodge(width=0.2), stat="identity", size = 2.5)+
  geom_bar(stat="identity", aes(y=share_women_field, x=general_field), alpha=0.2, width = 0.4)+
  guides(fill = guide_legend(reverse=TRUE, title = "Measure"))+
  scale_y_continuous(limits=c(0, 0.5))+
  coord_flip()+
  xlab("")+
  ylab("% Women")+
  labs(color = "Attention type",
       shape = "Attention type")+
  ggtitle("Share of total attention")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))
```


Plot this out:
```{r fig.width=6.5, fig.height=4, warning = F}

ggsave2(
  filename = "results/suppl/Plot_1_suppl.png",
  plot = repr_attn_share,
  width = 6.5,
  height = 4,
  units = c("in"),
  dpi = 300,
  bg = "white"
)

repr_attn_share
```



# Regression models

First, obtain binary variables for any attention received that year:
```{r}
prof_panel_filter$any_news <- as.factor(ifelse(prof_panel_filter$news_all > 0, 1, 0))
prof_panel_filter$any_news_l <- as.factor(ifelse(prof_panel_filter$news_all_l > 0, 1, 0))

prof_panel_filter$any_online_news <- as.factor(ifelse(prof_panel_filter$alt_online_all > 0, 1, 0))
prof_panel_filter$any_online_news_l <- as.factor(ifelse(prof_panel_filter$alt_online_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_gen <- as.factor(ifelse(prof_panel_filter$alt_online_general_all > 0, 1, 0))
prof_panel_filter$any_online_news_gen_l <- as.factor(ifelse(prof_panel_filter$alt_online_general_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_name <- as.factor(ifelse(prof_panel_filter$alt_online_name_all > 0, 1, 0))
prof_panel_filter$any_online_news_name_l <- as.factor(ifelse(prof_panel_filter$alt_online_name_all_l > 0, 1, 0))

prof_panel_filter$any_twitter <- as.factor(ifelse(prof_panel_filter$alt_twitter > 0, 1, 0))
prof_panel_filter$any_twitter_l <- as.factor(ifelse(prof_panel_filter$alt_twitter_l > 0, 1, 0))
```

Then, construct a binary variables for belonging to the top 10/20% in the attention for each source.
```{r}
panel_filter_long <- prof_panel_filter %>%
  pivot_longer(c(alt_online_all, alt_online_name_all, news_all, alt_twitter), names_to = "measure", values_to = "value")

top_10_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.90, na.rm = TRUE)<=value)%>%
  select(profile_id, general_field, year, measure, value)

top_10_attn$measure <- paste0(top_10_attn$measure, "_top_10")


top_10_attn <- top_10_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_10'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_10_attn[c("year", "profile_id", "general_field", "alt_online_all_top_10", "alt_online_name_all_top_10", "alt_twitter_top_10", "news_all_top_10")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

top_20_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.80, na.rm = TRUE)<=value)%>%
  select(profile_id, general_field, year, measure, value)

top_20_attn$measure <- paste0(top_20_attn$measure, "_top_20")


top_20_attn <- top_20_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_20'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_20_attn[c("year", "profile_id", "general_field", "alt_online_all_top_20", "alt_online_name_all_top_20", "alt_twitter_top_20", "news_all_top_20")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

prof_panel_filter <- filter(prof_panel_filter, !is.na(general_field))

# if NA, needs to be 0
prof_panel_filter <- prof_panel_filter %>%
  mutate(across(contains('top_10'),  ~ifelse(is.na(.), 0, .)))%>%
  mutate(across(contains('top_20'),  ~ifelse(is.na(.), 0, .)))
```
Log of variables:
```{r}
prof_panel_filter$news_all_log <- log(prof_panel_filter$news_all+1)
prof_panel_filter$news_all_l_log <- log(prof_panel_filter$news_all_l+1)

prof_panel_filter$alt_online_all_log <- log(prof_panel_filter$alt_online_all+1)
prof_panel_filter$alt_online_all_l_log <- log(prof_panel_filter$alt_online_all_l+1)

prof_panel_filter$alt_twitter_log <- log(prof_panel_filter$alt_twitter+1)
prof_panel_filter$alt_twitter_l_log <- log(prof_panel_filter$alt_twitter_l+1)
# there is a problem with this variable
prof_panel_filter$cited_by_total_all_l_log <- log(prof_panel_filter$cited_by_total_all_l+1)
prof_panel_filter$cited_by_total_all_l_log[which(is.nan(prof_panel_filter$cited_by_total_all_l_log))] <- NA
prof_panel_filter$cited_by_total_all_l_log[which(is.infinite(prof_panel_filter$cited_by_total_all_l_log))] <- NA
prof_panel_filter$alt_online_all_total_l_log <- log(prof_panel_filter$alt_online_all_total_l+1)
prof_panel_filter$alt_twitter_total_l_log <- log(prof_panel_filter$alt_twitter_total_l+1)
prof_panel_filter$coa_tot_cited_by_total_l_log <- log(prof_panel_filter$coa_tot_cited_by_total_l+1)
prof_panel_filter$coa_online_all_total_l_log <- log(prof_panel_filter$coa_online_all_total_l+1)
prof_panel_filter$coa_twitter_total_l_log <- log(prof_panel_filter$coa_twitter_total_l+1)

prof_panel_filter$news_all_total_l_log <- log(prof_panel_filter$news_all_total_l+1)


```


Split datasets per field:
```{r}
stem <- filter(prof_panel_filter, general_field == "STEM")
soc_sci <- filter(prof_panel_filter, general_field == "Social sciences")
arts <- filter(prof_panel_filter, general_field == "Arts & Humanities")
medicine <- filter(prof_panel_filter, general_field == "Medicine")
```

## Main models

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(news_all ~ 
                     # gender
                     inferred_gender +
                     # past period news
                     news_all_l + 
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset) 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  # extracting R squared
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)
  # prediction for our plots
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  # binding the predictions for all fields together
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
all_comparisons_news$x <- c(1, 2, 3, 4)
all_comparisons_news$groups <- 'c("m", "w")'
all_comparisons_news$xmin <- c(0.8, 1.8, 2.8, 3.8)
all_comparisons_news$xmax <- c(1.2, 2.2, 3.2, 4.2)

news_gender_plot <- all_predictions_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  ggtitle("(a) News attention")+
  stat_pvalue_manual(
    all_comparisons_news,
    y.position = c(4.6, 6.2, 4.6, 5.3),
    label.size = 3,
    tip.length = 0.003,
    label = "{stars}",
    remove.bracket = FALSE,
  )+
  xlab("Field")+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("News attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12, angle = 30, hjust = 0.9),
        legend.title=element_text(size=10), 
        legend.text=element_text(size=9))
```


See the results:
```{r}
kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_online_all ~ # professor publication variables
                     alt_online_all_l+
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset) 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                                       prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|t|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
all_comparisons_online_news$x <- c(1, 2, 3, 4)
all_comparisons_online_news$groups <- 'c("m", "w")'
all_comparisons_online_news$xmin <- c(0.8, 1.8, 2.8, 3.8)
all_comparisons_online_news$xmax <- c(1.2, 2.2, 3.2, 4.2)

online_news_gender_plot <- all_predictions_online_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  #ylim(2, 5.5)+
  ggtitle("(b) Online news attention")+
  stat_pvalue_manual(
    all_comparisons_online_news,
    y.position = c(13.5, 7, 20.5, 2),
    label.size = 3,
    tip.length = 0.003,
    label = "{stars}",
    remove.bracket = FALSE,
  )+
  xlab("Field")+
  scale_x_discrete()+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("Online news attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12, angle = 30, hjust = 0.9),
        legend.title=element_text(size=10), 
        legend.text=element_text(size=9))

```

```{r}
kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_twitter ~ # professor publication variables
                     alt_twitter_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset) 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
# add some variables we need to mark comparisons
all_comparisons_twitter$x <- c(1, 2, 3, 4)
all_comparisons_twitter$groups <- 'c("m", "w")'
all_comparisons_twitter$xmin <- c(0.8, 1.8, 2.8, 3.8)
all_comparisons_twitter$xmax <- c(1.2, 2.2, 3.2, 4.2)

twitter_gender_plot <- all_predictions_twitter %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  #ylim(2, 5.5)+
  ggtitle("(c) Twitter attention")+
  stat_pvalue_manual(
    all_comparisons_twitter,
    y.position = c(50, 27, 96, 6),
    label.size = 3,
    tip.length = 0.003,
    label = "{stars}",
    remove.bracket = FALSE,
  )+
  xlab("Field")+
  scale_x_discrete()+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("Twitter attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 12),
        axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12, angle = 30, hjust = 0.9),
        legend.title=element_text(size=10), 
        legend.text=element_text(size=9))
```

```{r}
kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("News attention",
                                                "Online news attention",
                                                "Twitter attention" ))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Plot out selected variables:
```{r fig.width = 10.5, fig.height = 3}
(selected_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l") & field == "stem") %>%
  ggplot(aes(Estimate, field, color = model, label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_y_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_x_continuous(
    n.breaks = 4,
    labels = label_comma())+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    color = "Attention type"
  ) + 
  geom_vline(xintercept = 0,  colour="black", linetype = "longdash")+
  facet_wrap( ~ term, scales="free_x", labeller = as_labeller(covariate_names), ncol = 4)+
  theme_minimal_grid()+
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12) ,
        axis.title.x = element_text(size = 13),
        axis.title.y =  element_blank(),
        legend.title=element_text(size=13), 
        legend.text=element_text(size=11),
        strip.text.x = element_text(size = 13)))
```


Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
(network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
  
```

Cumulative advantage plot:
```{r fig.width = 10, fig.height = 5.5}
(cumulative_plot <- all_models_news_plot %>%
   filter(term %in% c("t_min_1")) %>%
   ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Cumulative advantage"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```


Cumulative advantage plot INAS:
```{r fig.width = 10, fig.height = 5.5}
(cumulative_plot_inas <- all_models_news_plot %>%
   filter(term %in% c("t_min_1") & field == "stem") %>%
   ggplot(aes(Estimate, field, color = model, label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_y_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_x_continuous(
    n.breaks = 4,
    labels = label_comma())+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Selected covariates",
    color = "Attention type"
  ) + 
  geom_vline(xintercept = 0,  colour="black", linetype = "longdash")+
  facet_wrap( ~ term, scales="free_x", labeller = as_labeller(covariate_names), ncol = 2)+
  theme_minimal_grid()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        axis.title.y =  element_blank(),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
```


Control variables plot:
```{r fig.width = 14, fig.height = 5.5}
(controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```

Save the plots:
```{r}

legend <- get_legend(
  # create some space to the left of the legend
  news_gender_plot
)

combi_plot <- plot_grid(news_gender_plot + theme(legend.position="none"), 
                                 online_news_gender_plot + theme(legend.position="none"),
                                 twitter_gender_plot + theme(legend.position="none"),
                                 legend,
                                 ncol = 4,
                                 rel_widths = c(1, 1, 1, 0.3))

ggsave2(
  filename = "results/main/reg_gender_diff.png",
  plot = combi_plot,
  width = 12,
  height = 4,
  units = c("in"),
  dpi = 600,
  bg = "white"
)

png(height=5.5, width=6, 
    unit = "in", 
    res = 600,
    file="results/main/reg_cumulative.png")
cumulative_plot
dev.off()

png(height=3, width=6, 
    unit = "in", 
    res = 600,
    file="results/main/reg_cumulative_inas.png")
cumulative_plot_inas
dev.off()


png(height=3, width=10.5, 
    unit = "in", 
    res = 600,
    file="results/main/reg_selected.png")
selected_plot
dev.off()


png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/main/reg_network.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/main/reg_controls.png")
controls_plot
dev.off()


```
Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_news.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_online_news.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_twitter.csv", row.names=FALSE)
```


## Robustness checks

### Log-transformed variables

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(news_all_log ~ 
                     # gender
                     inferred_gender +
                     # citations
                     cited_by_total_all_l_log + 
                     # attention variables
                     alt_online_all_total_l_log + alt_twitter_total_l_log +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l_log +
                     # coauthor attention variables
                     coa_online_all_total_l_log + coa_twitter_total_l_log+
                     # year trends control
                     as.factor(year),
                   data = field_dataset) 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  # extracting R squared
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)
  # prediction for our plots
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  # binding the predictions for all fields together
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
news_gender_plot <- all_predictions_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  ggtitle("(a) Predicted values of news attention")+
  stat_pvalue_manual(
    all_comparisons_news,
    y.position = c(1, 1.15, 0.9, 1.1),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
  )+
  xlab("Field")+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("News attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=8), 
        legend.text=element_text(size=7))
```


See the results:
```{r}
kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_online_all_log ~ # professor publication variables
                     cited_by_total_all_l_log + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l_log + alt_twitter_total_l_log +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l_log +
                     # coauthor publication variables
                     coa_online_all_total_l_log + coa_twitter_total_l_log+
                     as.factor(year),
                   data = field_dataset) 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                                       prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|t|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
online_news_gender_plot <- all_predictions_online_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  #ylim(2, 5.5)+
  ggtitle("(b) Predicted values of online news attention")+
  stat_pvalue_manual(
    all_comparisons_online_news,
    y.position = c(7, 7, 4, 4),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
  )+
  xlab("Field")+
  scale_x_discrete()+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("Online news attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=8), 
        legend.text=element_text(size=7))

```

```{r}
kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_twitter_log ~ # professor publication variables
                     cited_by_total_all_l_log + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l_log +
                     alt_online_all_total_l_log +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l_log +
                     # coauthor publication variables
                     coa_online_all_total_l_log + coa_twitter_total_l_log+
                     as.factor(year),
                   data = field_dataset) 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
twitter_gender_plot <- all_predictions_twitter %>%
   ggplot(aes(x = fct_rev(field),
              y = predicted,
              ymin = conf.low,
              ymax = conf.high,
              color = x)) +
   geom_pointrange(position = position_dodge(width = 0.5),
                   size = 0.5)+
   #ylim(2, 5.5)+
   ggtitle("(c) Predicted values of Twitter attention")+
     stat_pvalue_manual(
    all_comparisons_twitter,
    y.position = c(0, 26, 0, 10),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
    )+
    xlab("Field")+
   scale_x_discrete()+
   scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social science",
                             "stem" = "STEM"))+
   ylab("Twitter attention per year")+
   labs(color = "Inferred gender")+
   scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
   theme_minimal_hgrid()+
   theme(plot.title = element_text(size = 8),
         axis.text.y = element_text(size = 8),
         axis.title.y = element_text(size = 10),
         axis.text.x = element_text(size = 8) ,
         axis.title.x = element_text(size = 10),
         legend.title=element_text(size=8), 
         legend.text=element_text(size=7))
```

```{r}
knitr::kable(all_models_twitter)
```

Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_log.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_log.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_log.csv", row.names=FALSE)
```

### No lagged variable

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(news_all ~ 
                     # gender
                     inferred_gender +
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset) 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  # extracting R squared
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)
  # prediction for our plots
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  # binding the predictions for all fields together
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
news_gender_plot <- all_predictions_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  ggtitle("(a) Predicted values of news attention")+
  stat_pvalue_manual(
    all_comparisons_news,
    y.position = c(1, 1.15, 0.9, 1.1),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
  )+
  xlab("Field")+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("News attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=8), 
        legend.text=element_text(size=7))
```


See the results:
```{r}
kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_online_all ~ # professor publication variables
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset) 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                                       prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|t|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|t|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
online_news_gender_plot <- all_predictions_online_news %>%
  ggplot(aes(x = fct_rev(field),
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  #ylim(2, 5.5)+
  ggtitle("(b) Predicted values of online news attention")+
  stat_pvalue_manual(
    all_comparisons_online_news,
    y.position = c(7, 7, 4, 4),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
  )+
  xlab("Field")+
  scale_x_discrete()+
  scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social science",
                            "stem" = "STEM"))+
  ylab("Online news attention per year")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8) ,
        axis.title.x = element_text(size = 10),
        legend.title=element_text(size=8), 
        legend.text=element_text(size=7))

```

```{r}
kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- lm(alt_twitter ~ # professor publication variables
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset) 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(summary(lm_model)$r.squared,3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|t|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|t|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|t|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
twitter_gender_plot <- all_predictions_twitter %>%
   ggplot(aes(x = fct_rev(field),
              y = predicted,
              ymin = conf.low,
              ymax = conf.high,
              color = x)) +
   geom_pointrange(position = position_dodge(width = 0.5),
                   size = 0.5)+
   #ylim(2, 5.5)+
   ggtitle("(c) Predicted values of Twitter attention")+
     stat_pvalue_manual(
    all_comparisons_twitter,
    y.position = c(0, 26, 0, 10),
    label.size = 3,
    label = "{stars}",
    remove.bracket = FALSE,
    bracket.nudge.y = -2,
    x = "field"
    )+
    xlab("Field")+
   scale_x_discrete()+
   scale_x_discrete(labels=c("arts" = "Arts & Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social science",
                             "stem" = "STEM"))+
   ylab("Twitter attention per year")+
   labs(color = "Inferred gender")+
   scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Man", "Woman"))+
   theme_minimal_hgrid()+
   theme(plot.title = element_text(size = 8),
         axis.text.y = element_text(size = 8),
         axis.title.y = element_text(size = 10),
         axis.text.x = element_text(size = 8) ,
         axis.title.x = element_text(size = 10),
         legend.title=element_text(size=8), 
         legend.text=element_text(size=7))
```

```{r}
kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("Twitter attention",
                                                "Online news attention",
                                                "News attention"))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12))

controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12))
```

Save the plots:
```{r}

legend <- get_legend(
  # create some space to the left of the legend
  news_gender_plot
)

combi_plot <- plot_grid(news_gender_plot + theme(legend.position="none"), 
                                 online_news_gender_plot + theme(legend.position="none"),
                                 twitter_gender_plot + theme(legend.position="none"),
                                 legend,
                                 ncol = 4,
                                 rel_widths = c(1, 1, 1, 0.3))

ggsave2(
  filename = "results/suppl/reg_rob/reg_gender_diff_no_lag.png",
  plot = combi_plot,
  width = 12,
  height = 3,
  units = c("in"),
  dpi = 600,
  bg = "white"
)

png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_network_no_lag.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_controls_no_lag.png")
controls_plot
dev.off()
```

Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_no_lag.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_no_lag.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_no_lag.csv", row.names=FALSE)
```


### Count models - Poisson

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(news_all ~ 
                     news_all_l + 
                     # gender
                     inferred_gender +
                     # past period news
                     news_all_l + 
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset, 
                   family = 'poisson') 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)
  # prediction for our plots
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  # binding the predictions for all fields together
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

See the results:
```{r}
knitr::kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_online_all ~ # professor publication variables
                     alt_online_all_l+
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset,
                  family = 'poisson') 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                                       prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

```{r}
knitr::kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_twitter ~ # professor publication variables
                     alt_twitter_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset, 
                 family = 'poisson') 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, vcov = vcovCL, cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

```{r}
knitr::kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("Twitter attention",
                                                "Online news attention",
                                                "News attention"))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
(network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
  
```

Cumulative advantage plot:
```{r fig.width = 10, fig.height = 5.5}
(cumulative_plot <- all_models_news_plot %>%
   filter(term %in% c("t_min_1")) %>%
   ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Cumulative advantage"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```
Control variables plot:
```{r fig.width = 14, fig.height = 5.5}
(controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```

Save the plots:
```{r}
png(height=5.5, width=6, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_cumulative_poisson.png")
cumulative_plot
dev.off()

png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_network_poisson.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_controls_poisson.png")
controls_plot
dev.off()


```
Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_poisson.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_poisson.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_poisson.csv", row.names=FALSE)
```


### Logistic models - any attention

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(any_news ~ 
                     news_all_l + 
                     # gender
                     inferred_gender +
                     # past period news
                     news_all_l + 
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset, 
                   family = 'binomial') 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)
  # prediction for our plots
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  # binding the predictions for all fields together
  all_predictions_news <- rbind(all_predictions_news,
                           prediction)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

See the results:
```{r}
knitr::kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_online_news <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(any_online_news ~ # professor publication variables
                     alt_online_all_l+
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset,
                  family = 'binomial') 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  all_predictions_online_news <- rbind(all_predictions_online_news,
                                       prediction)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

```{r}
knitr::kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_predictions_twitter <- data.frame(matrix(ncol = 7, nrow = 0))
all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(any_twitter ~ # professor publication variables
                     alt_twitter_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset, 
                 family = 'binomial') 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  prediction <- predict_response(lm_model, c("inferred_gender"), vcov_fun = "vcovCL", 
                                 vcov_type = "HC0",
                                 vcov.args = list(cluster = field_dataset$profile_id))
  prediction$field <- field
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  all_predictions_twitter <- rbind(all_predictions_twitter,
                           prediction)
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

```{r}
knitr::kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("Twitter attention",
                                                "Online news attention",
                                                "News attention"))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
(network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
  
```

Cumulative advantage plot:
```{r fig.width = 10, fig.height = 5.5}
(cumulative_plot <- all_models_news_plot %>%
   filter(term %in% c("t_min_1")) %>%
   ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Cumulative advantage"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```
Control variables plot:
```{r fig.width = 14, fig.height = 5.5}
(controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```

Save the plots:
```{r}
png(height=5.5, width=6, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_cumulative_any_att.png")
cumulative_plot
dev.off()

png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_network_any_att.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_controls_any_att.png")
controls_plot
dev.off()


```
Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_any_att.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_any_att.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_any_att.csv", row.names=FALSE)
```



### Logistic models - top 10 attention

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(news_all_top_10 ~ 
                     news_all_l + 
                     # gender
                     inferred_gender +
                     # past period news
                     news_all_l + 
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset, 
                   family = 'binomial') 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

See the results:
```{r}
knitr::kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_online_all_top_10 ~ # professor publication variables
                     alt_online_all_l+
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset,
                  family = 'binomial') 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

```{r}
knitr::kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_twitter_top_10 ~ # professor publication variables
                     alt_twitter_l + 
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset, 
                 family = 'binomial') 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

```{r}
knitr::kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("Twitter attention",
                                                "Online news attention",
                                                "News attention"))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
(network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
  
```

Cumulative advantage plot:
```{r fig.width = 10, fig.height = 5.5}
(cumulative_plot <- all_models_news_plot %>%
   filter(term %in% c("t_min_1")) %>%
   ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Cumulative advantage"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```
Control variables plot:
```{r fig.width = 14, fig.height = 5.5}
(controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```

Save the plots:
```{r}
png(height=5.5, width=6, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_cumulative_top_10_att.png")
cumulative_plot
dev.off()

png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_network_top_10_att.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_controls_top_10_att.png")
controls_plot
dev.off()


```
Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_top_10_att.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_top_10_att.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_top_10_att.csv", row.names=FALSE)
```



### Logistic models - top 10 attention

News attention models, per field, controlling for:
- last time period's news
- total citations received up to the last period
- total online attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.

```{r warning = F}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(news_all_top_10 ~ 
                     # gender
                     inferred_gender +
                     # past period news
                     news_all_l + 
                     # citations
                     cited_by_total_all_l + 
                     # attention variables
                     alt_online_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor attention variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     # year trends control
                     as.factor(year),
                   data = field_dataset, 
                   family = 'binomial') 
  
  # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  
  model_result$field <- field
  # binding field models together
  all_models_news <- rbind(all_models_news,
                      model_result)

  # comparing whether the predictions for men and women are significantly different
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_news <- rbind(all_comparisons_news,
                           gender_comparison)
  
  
}

# adding some stars
all_models_news$stars <- ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_news$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_news$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_news$stars <- ifelse(all_comparisons_news$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_news$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_news$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_news$`p.value` <= 0.1, ".", ""))))

# tidying up and rounding the results
all_comparisons_news$group1 <- str_split_i(all_comparisons_news$inferred_gender, "-", 1)
all_comparisons_news$group2 <- str_split_i(all_comparisons_news$inferred_gender, "-", 2)
all_comparisons_news$p_rounded <- round(all_comparisons_news$p.value, 4)
```

See the results:
```{r}
knitr::kable(all_models_news)
```


Online news attention models, per field, controlling for:
- last time period's online news news
- total citations received up to the last period
- total news attention received up to  the last period
- total twitter attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_online_news <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_online_news <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_online_all_top_10 ~ # professor publication variables
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender  +
                     # attention variables
                     news_all_total_l + alt_twitter_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset,
                  family = 'binomial') 
    # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_online_news <- rbind(all_models_online_news,
                                  model_result)
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_online_news <- rbind(all_comparisons_online_news,
                                       gender_comparison)
  
  
}

all_models_online_news$stars <- ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "***",
                                       ifelse(all_models_online_news$`Pr(>|z|)` <= 0.001, "**",
                                              ifelse(all_models_online_news$`Pr(>|z|)` <= 0.05, "*",
                                                     ifelse(all_models_online_news$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_online_news$stars <- ifelse(all_comparisons_online_news$`p.value` <= 0.001, "***",
                                            ifelse(all_comparisons_online_news$`p.value` <= 0.001, "**",
                                                   ifelse(all_comparisons_online_news$`p.value` <= 0.05, "*",
                                                          ifelse(all_comparisons_online_news$`p.value` <= 0.1, ".", ""))))

all_comparisons_online_news$group1 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 1)
all_comparisons_online_news$group2 <- str_split_i(all_comparisons_online_news$inferred_gender, "-", 2)

all_comparisons_online_news$p_rounded <- round(all_comparisons_online_news$p.value, 4)
```

```{r}
knitr::kable(all_models_online_news)
```

Twitter attention models, per field, controlling for:
- last time period's twitter attention
- total citations received up to the last period
- total online attention received up to  the last period
- total news attention received up to the last period
- total citations received by all coauthors up to the last period
- online attention received by all coauthors up to the last period
- twitter attention received by all coauthors up to the last period
- year control
Individual clustered SE.
```{r}
fields <- c("stem", "soc_sci", "medicine", "arts")

all_models_twitter <- data.frame(matrix(ncol = 10, nrow = 0))
all_comparisons_twitter <- data.frame(matrix(ncol = 6, nrow = 0))

for (field in fields){
  
  field_dataset <- get(field)
  
  lm_model <- glm(alt_twitter_top_10 ~ # professor publication variables
                     cited_by_total_all_l + 
                     # gender
                     inferred_gender +
                     # attention variables
                     news_all_total_l +
                     alt_online_all_total_l +
                     # coauthor publication variables
                     coa_tot_cited_by_total_l +
                     # coauthor publication variables
                     coa_online_all_total_l + coa_twitter_total_l+
                     as.factor(year),
                   data = field_dataset, 
                 family = 'binomial') 
  
      # cluster-robust SEs
  coef_test_output <- coeftest(lm_model, type = "HC0", cluster = ~profile_id)
  model_result <- coef_test_output[,] %>% 
    as.data.frame() %>% 
   rownames_to_column(var = "term")
  model_result$lower_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,1]
  model_result$upper_ci <- as.data.frame(confint(coef_test_output,
                                                 level = 0.95))[,2]
  
  model_result[nrow(model_result)+1, 1] <- "R^2"
  model_result[nrow(model_result), 2:ncol(model_result)] <- round(PseudoR2(lm_model),3)
  model_result$field <- field
  
  all_models_twitter <- rbind(all_models_twitter,
                      model_result)
  
  
  gender_comparison <- test_predictions(lm_model, c("inferred_gender"), vcov_fun = "vcovCL")
  gender_comparison$field <- field
  
  all_comparisons_twitter <- rbind(all_comparisons_twitter,
                           gender_comparison)
  
  
  
}

all_models_twitter$stars <- ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "***",
                           ifelse(all_models_twitter$`Pr(>|z|)` <= 0.001, "**",
                                  ifelse(all_models_twitter$`Pr(>|z|)` <= 0.05, "*",
                                         ifelse(all_models_twitter$`Pr(>|z|)` <= 0.1, ".", ""))))

all_comparisons_twitter$stars <- ifelse(all_comparisons_twitter$`p.value` <= 0.001, "***",
                           ifelse(all_comparisons_twitter$`p.value` <= 0.001, "**",
                                  ifelse(all_comparisons_twitter$`p.value` <= 0.05, "*",
                                         ifelse(all_comparisons_twitter$`p.value` <= 0.1, ".", ""))))

all_comparisons_twitter$group1 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 1)
all_comparisons_twitter$group2 <- str_split_i(all_comparisons_twitter$inferred_gender, "-", 2)

all_comparisons_twitter$p_rounded <- round(all_comparisons_twitter$p.value, 4)
```

```{r}
knitr::kable(all_models_twitter)
```


Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r fig.width = 15, fig.height = 4}
all_models_news$model <- "News attention"
all_models_online_news$model <- "Online news attention"
all_models_twitter$model <- "Twitter attention"

all_models_news_plot <- rbind(all_models_news,
                              all_models_online_news,
                              all_models_twitter)
# do the t-1 of dependent as a single variable
all_models_news_plot$term <- ifelse(all_models_news_plot$term %in% c("news_all_l",
                                                                     "alt_online_all_l",
                                                                     "alt_twitter_l"), 
                                    "t_min_1", 
                                    all_models_news_plot$term)


all_models_news_plot$term <- ordered(all_models_news_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "t_min_1",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_online_all_total_l",
                                                "coa_twitter_total_l",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))

all_models_news_plot$model <- ordered(all_models_news_plot$model,
                                     levels = c("Twitter attention",
                                                "Online news attention",
                                                "News attention"))


all_models_news_plot$field <- ordered(all_models_news_plot$field,
                                     levels = c("stem",
                                                "soc_sci",
                                                "medicine",
                                                "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Citations - total",
  'news_all_total_l'="News attention\n- total",
  'alt_online_all_total_l'="Online news\n attention - total",
  'alt_twitter_total_l'="Twitter attention\n - total",
  'coa_tot_cited_by_total_l' = "Coauthor citations\n - total",
  'coa_online_all_total_l' = "Coauthor online\n news attention\n - total",
  'coa_twitter_total_l' = "Coauthor twitter\n attention - total"
)
```

Now, plot out the network variables:
```{r fig.width = 12, fig.height = 5.5}
(network_plot <- all_models_news_plot %>%
  filter(term %in% c("coa_tot_cited_by_total_l",
                     "coa_online_all_total_l",
                     "coa_twitter_total_l")) %>%
  ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
  scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                "medicine" = "Medicine",
                                "soc_sci" = "Social science",
                                "stem" = "STEM"),
                       name = "Field")+
  scale_x_continuous(
    n.breaks = 4)+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    title = "Network variables"
  ) + 
  geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
  facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
  theme_bw()+
  theme(plot.title = element_text(size = 14),
        axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11) ,
        axis.title.x = element_text(size = 12),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 12)))
  
```

Control variables plot:
```{r fig.width = 14, fig.height = 5.5}
(controls_plot <- all_models_news_plot %>%
  filter(term %in% c("cited_by_total_all_l",
                     "news_all_total_l",
                     "alt_online_all_total_l", 
                     "alt_twitter_total_l")) %>%
 ggplot(aes(Estimate, model, color = rev(field), label = stars)) +
   geom_point(position = position_dodge(width = -0.7), size = 3) +
   geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                 width=0,
                 size=0.7,
                 position = position_dodge(width = -0.7)) +
   geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 6)+
   scale_color_discrete(labels=c("arts" = "Arts & Humanities",
                                 "medicine" = "Medicine",
                                 "soc_sci" = "Social science",
                                 "stem" = "STEM"),
                        name = "Field")+
   scale_x_continuous(
     n.breaks = 4)+
   # add in a dotted line at zero
   labs(
     x = "Regression coefficient",
     y = NULL,
     title = "Control variables"
   ) + 
   geom_vline(xintercept = 0,  colour="grey", linetype = "longdash")+
   facet_grid( ~ term, scales="free_x", labeller = as_labeller(covariate_names))+
   theme_bw()+
   theme(plot.title = element_text(size = 14),
         axis.text.y = element_text(size = 11),
         axis.text.x = element_text(size = 11) ,
         axis.title.x = element_text(size = 12),
         legend.title=element_text(size=12), 
         legend.text=element_text(size=10),
         strip.text.x = element_text(size = 12)))
```

Save the plots:
```{r}
png(height=5.5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_network_top_10_att_no_lag.png")
network_plot
dev.off()

png(height=5.5, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/reg_rob/reg_controls_top_10_att_no_lag.png")
controls_plot
dev.off()


```
Save the model coefficients:
```{r}
write.csv(all_models_news, "results/suppl/reg_rob/reg_news_top_10_att_no_lag.csv", row.names=FALSE)
write.csv(all_models_online_news, "results/suppl/reg_rob/reg_online_news_top_10_att_no_lag.csv", row.names=FALSE)
write.csv(all_models_twitter, "results/suppl/reg_rob/reg_twitter_top_10_att_no_lag.csv", row.names=FALSE)
```



# Gini coefficients per cohort and field

## Lorenz curve

### Overall
```{r}
# prepare the attention distributions
lorenz_overall <- sources_check %>%
  select(profile_id, news_all_total, alt_online_all_total, alt_twitter_total)%>%
  pivot_longer(news_all_total:alt_twitter_total, names_to = "source", values_to = "count")

lorenz_overall$source <- ordered(lorenz_overall$source,
                                 levels = c("news_all_total",
                                            "alt_online_all_total",
                                            "alt_twitter_total"))

# get the gini coefficients
gini_overall <- lorenz_overall %>%
  group_by(source) %>%
  summarise(gini = Gini(count, na.rm = TRUE))

gini_overall$labels <- c("News", "Online news", "Twitter")

gini_overall$gini_label <- paste(gini_overall$labels, ":", round(gini_overall$gini, 2))

labels_gini <- paste("Gini coefficients", paste(gini_overall$gini_label, collapse = "\n"), sep = "\n")


(lorenz_overall_plot <- lorenz_overall %>%
    ggplot(aes(x = count, colour = source)) +
    stat_lorenz(size = 1.2, desc = FALSE) +
    scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
    coord_fixed() +
    geom_abline(linetype = "dashed") +
    theme_minimal() +
    annotate("text", label = labels_gini, x = 0.15, y = 0.9, color = "black", size = 3) +
    labs(x = "Cumulative percentage of professors",
         y = "Cumulative percentage of attention")+
    labs(color = "Attention type")+
    theme_minimal()+
    theme(plot.title = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_blank(),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10)))


png(height=6, width=7, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/lorenz_overall_total.png")

lorenz_overall_plot
dev.off()
```
## Per field
```{r fig.width=8, fig.height=10}
# prepare the attention distributions
lorenz_field <- sources_check %>%
  select(profile_id, general_field, news_all_total, alt_online_all_total, alt_twitter_total)%>%
  pivot_longer(news_all_total:alt_twitter_total, names_to = "source", values_to = "count")

lorenz_field$source <- ordered(lorenz_field$source,
                                 levels = c("news_all_total",
                                            "alt_online_all_total",
                                            "alt_twitter_total"))

# get the gini coefficients
gini_field <- lorenz_field %>%
  group_by(general_field, source) %>%
  summarise(gini = Gini(count, na.rm = TRUE))

gini_field$labels <- rep(c("News", "Online news", "Twitter"), 4)
gini_field$gini_label <- paste(gini_field$labels, ":", round(gini_field$gini, 2))

labels_gini <- gini_field %>%
  group_by(general_field) %>%
  mutate(label_text = paste(gini_label, collapse = "\n"))%>%
  distinct(label_text)

labels_gini$label_text <- paste("Gini coefficients", labels_gini$label_text, sep = "\n")
labels_gini$source <- "news_all_total"


(lorenz_field_plot <- lorenz_field %>%
  ggplot(., aes(x = count, colour = source)) +
  stat_lorenz(size = 1.2, desc = FALSE) +
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  coord_fixed() +
  geom_abline(linetype = "dashed") +
  theme_minimal() +
  labs(x = "Cumulative percentage of professors",
       y = "Cumulative percentage of attention")+
  labs(color = "Attention type")+
  facet_wrap(~general_field)+
  geom_text(labels_gini, mapping = aes(label = label_text, y = 0.85, x = 0.2), color = "black", size = 4) +
  theme_minimal()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10),
        strip.text = element_text(size=12)))

png(height=8, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/lorenz_field_total.png")

lorenz_field_plot
dev.off()

```

If cumulative advantage processes are at hand, we should likely see increasing 
inequality within our fields.

First, let's check the trends for all of our indicators over time:
```{r}
total_trends <- prof_panel_filter %>%
  filter(year >= 2011)%>%
  group_by(general_field, year)%>%
  summarise(`News` = sum(news_all, na.rm = TRUE),
            `Online news` = sum(alt_online_all, na.rm = TRUE),
            `Twitter` = sum(alt_twitter, na.rm = TRUE))%>%
  pivot_longer(`News`:`Twitter`, names_to = "indicator", values_to = "total")

average_trends <- prof_panel_filter %>%
  filter(year >= 2011)%>%
  group_by(general_field, year)%>%
  summarise(`News` = mean(news_all, na.rm = TRUE),
            `Online news` = mean(alt_online_all, na.rm = TRUE),
            `Twitter` = mean(alt_twitter, na.rm = TRUE))%>%
  pivot_longer(`News`:`Twitter`, names_to = "indicator", values_to = "total")

averages_news <- average_trends %>%
  filter(indicator == "News")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 10)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(i) Average")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

averages_online_news <- average_trends %>%
  filter(indicator == "Online news")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 40)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(i) Average")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

averages_twitter <- average_trends %>%
  filter(indicator == "Twitter")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 200)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(i) Average")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

totals_news <- total_trends %>%
  filter(indicator == "News")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 20000)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(ii) Total")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

totals_online_news <- total_trends %>%
  filter(indicator == "Online news")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 70000),  breaks = c(0, 17500, 35000, 52500, 70000)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(ii) Total")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

totals_twitter <- total_trends %>%
  filter(indicator == "Twitter")%>%
    ggplot( aes(x=year, y=total, color = general_field)) +
    geom_line()+
    scale_y_continuous(labels = label_comma(), n.breaks = 5, limits = c(0, 350000), breaks = c(0,  87500, 175000, 262500, 350000)) +
    xlab("Year")+
    ylab("Mentions")+
    ggtitle("(ii) Total")+
    labs(color = "Field")+
    theme_minimal_vgrid()+
    theme(plot.title = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.text.x = element_text(size = 10) ,
          axis.title.x = element_text(size = 11),
          legend.title=element_text(size=11), 
          legend.text=element_text(size=10))

legend <- get_legend(
  # create some space to the left of the legend
  averages_news
)

news <- plot_grid(averages_news+ theme(legend.position="none"), totals_news+ theme(legend.position="none"), ncol = 1, align = "v")
online_news <- plot_grid(averages_online_news+ theme(legend.position="none"), totals_online_news+ theme(legend.position="none"), ncol = 1, align = "v")
twitter <- plot_grid(averages_twitter, totals_twitter, ncol = 1, align = "v")


title_1 <- ggdraw() +
  draw_label("(a) News", x = 0.05, hjust = 0, fontface = "bold", size = 14)
title_2 <- ggdraw() +
  draw_label("(b) Online News", x = 0.05, hjust = 0, fontface = "bold", size = 14)
title_3 <- ggdraw() +
  draw_label("(c) Twitter", x = 0.05, hjust = 0, fontface = "bold", size = 14)

combi_plot <- plot_grid(
  title_1,
  title_2,
  title_3,
  news,
  online_news,
  twitter,
  ncol = 3,
  align = "v",
  rel_widths = c(1, 1, 1.5),
  rel_heights = c(0.1, 1))

# save the plot
ggsave2(
  filename = "results/suppl/averages_totals_mentions.png",
  plot = combi_plot,
  width = 14,
  height = 8,
  units = c("in"),
  dpi = 300,
  bg = "white"
)

```

## Overall inequality

Looking at the totals:
```{r}
gini_overall <- gender_gini(sources_check,
                        pub_data = FALSE,
                        totals = TRUE,
                        year = 2023,
                        field = "all")

gini_overall_plot <- gini_overall %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_overall_plot$variable <- as.factor(unlist(gini_overall_plot$variable))

gini_names <- c(
  'gini_between'="(a) Between groups",
  'gini_within'="(b) Within groups",
  'total_gini'="(c) Overall"
)


  
png(height=4, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/overall_totals.png")

gini_overall_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=variable, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()
```

And now yearly:
```{r}
years_individual <- c(2011:2023)


gini_overall_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

  for (i in 1:length(years_individual)){
    this_year <- years_individual[i]
    
    panel_year <- filter(prof_panel_filter,
                          year == this_year)
    
    gini_this_year <- gender_gini(panel_year,
                        pub_data = FALSE,
                        totals = FALSE,
                        year = this_year,
                        field = "all")
    
    gini_overall_yearly <- rbind(gini_overall_yearly,
                                 gini_this_year)
    
    
  }

gini_overall_yearly_plot <- gini_overall_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_overall_yearly_plot$variable <- as.factor(unlist(gini_overall_yearly_plot$variable))
gini_overall_yearly_plot$year <- as.numeric(unlist(gini_overall_yearly_plot$year))

png(height=4, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_totals.png")

gini_overall_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


```

## Inequality within fields

Overall gini in 2023 within the fields:
```{r}
fields <- unique(sources_check$general_field)
fields <- fields[1:4]

gini_per_field <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

  for (j in 1:length(fields)){
    this_field <- fields[j]
    
    sources_check_field <- filter(sources_check,
                                   entry_batch_2023 == year_group & general_field == this_field)
    
    gini_this_field <- gender_gini(sources_check_field,
                        pub_data = FALSE,
                        totals = TRUE,
                        year = 2023,
                        field = this_field)
    
    gini_per_field <- rbind(gini_per_field,
                            gini_this_field)
    
    
  }

gini_field_plot <- gini_per_field %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_field_plot$variable <- as.factor(unlist(gini_field_plot$variable))
gini_field_plot$field <- as.factor(unlist(gini_field_plot$field))


  
png(height=4, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/field_totals.png")

gini_field_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(.~gini_type, scales = "free_y", labeller = as_labeller(gini_names))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()
```
And now yearly:
```{r}
years_individual <- c(2011:2023)

gini_field_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

for (j in 1:length(fields)){
  this_field <- fields[j]
  for (i in 1:length(years_individual)){
    this_year <- years_individual[i]
    
    panel_year <- filter(prof_panel_filter,
                         year == this_year & general_field == this_field)
    
    gini_this_year <- gender_gini(panel_year,
                                  pub_data = FALSE,
                                  totals = FALSE,
                                  year = this_year,
                                  field = this_field)
    
    gini_field_yearly <- rbind(gini_field_yearly,
                               gini_this_year)
    
    
  }
}

gini_field_yearly_plot <- gini_field_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_field_yearly_plot$variable <- as.factor(unlist(gini_field_yearly_plot$variable))
gini_field_yearly_plot$field <- as.factor(unlist(gini_field_yearly_plot$field))
gini_field_yearly_plot$year <- as.numeric(unlist(gini_field_yearly_plot$year))



gini_names2 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'STEM' = "STEM",
  'Medicine' = "Medicine",
  'Arts & Humanities' = "Arts & Humanities",
  'Social sciences' = "Social sciences"
)


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field.png")

gini_field_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~field, scales = "free_y", labeller = as_labeller(gini_names2))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


```
## Inequality within fields and cohorts

Within the fields and cohorts:
```{r}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]


gini_per_field_cohort <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

gini_names3 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'up to 10' = "up to 10",
  'up to 20' = "up to 20",
  'up to 30' = "up to 30",
  'up to 40' = "up to 40",
  'up to 50' = "up to 50"
)


for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    this_field <- fields[j]
    
    sources_check_cohort <- filter(sources_check,
                                   entry_batch_2023 == year_group & general_field == this_field)
    
    gini_this_field_cohort <- gender_gini(sources_check_cohort,
                                          pub_data = FALSE,
                                          totals = TRUE,
                                          year = 2023,
                                          field = this_field)
    
    gini_this_field_cohort$cohort <- year_group
    
    gini_per_field_cohort <- rbind(gini_per_field_cohort,
                                   gini_this_field_cohort)
    
  }
}



gini_per_field_cohort_plot <- gini_per_field_cohort %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_per_field_cohort_plot$variable <- as.factor(unlist(gini_per_field_cohort_plot$variable))
gini_per_field_cohort_plot$field <- as.factor(unlist(gini_per_field_cohort_plot$field))
#gini_per_field_cohort_plot$year <- as.numeric(unlist(gini_per_field_cohort_plot$year))


  
png(height=10, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/field_cohort_totals.png")

gini_per_field_cohort_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(cohort~gini_type, scales = "free_y", labeller = as_labeller(gini_names3))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()   
```
Within the fields and cohorts per year:
```{r}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]

years_individual <- c(2011:2023)
    
gini_per_field_cohort_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

gini_names3 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'up to 10' = "up to 10",
  'up to 20' = "up to 20",
  'up to 30' = "up to 30",
  'up to 40' = "up to 40",
  'up to 50' = "up to 50"
)


for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    this_field <- fields[j]
    for (k in 1:length(years_individual)){
      this_year <- years_individual[k]
      
      panel_year <- filter(prof_panel_filter,
                           entry_batch_2023 == year_group & general_field == this_field & year == this_year)
      
      if (nrow(panel_year)>0){
      
      gini_this_year <- gender_gini(panel_year,
                                    pub_data = FALSE,
                                    totals = FALSE,
                                    year = this_year,
                                    field = this_field)
      
      gini_this_year$cohort <- year_group
      gini_this_year$year <- this_year
      
      gini_per_field_cohort_yearly <- rbind(gini_per_field_cohort_yearly,
                                            gini_this_year)
      }
      
    }
  }
}



gini_per_field_cohort_yearly_plot <- gini_per_field_cohort_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_per_field_cohort_yearly_plot$variable <- as.factor(unlist(gini_per_field_cohort_yearly_plot$variable))
gini_per_field_cohort_yearly_plot$field <- as.factor(unlist(gini_per_field_cohort_yearly_plot$field))
gini_per_field_cohort_yearly_plot$year <- as.numeric(unlist(gini_per_field_cohort_yearly_plot$year))


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_stem.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "STEM")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()

png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_soc_sci.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Social sciences")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_medicine.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Medicine")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_arts_hum.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Arts & Humanities")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()
```


# Gini coefficients per professor

If cumulative advantage processes are at hand, we should likely see increasing 
inequality within our fields.

## Calculating Gini for each professor
```{r fig.width=12}
gini_per_prof <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(general_field, profile_id)%>%
  #mutate(across(c(count_pubs, cited_by, news_all, alt_online_all, alt_twitter), ~ na_if(., 0)))%>%
  summarise(
    news = Gini(news_all, na.rm = TRUE),
    online_news = Gini(alt_online_all, na.rm = TRUE),
    twitter = Gini(alt_twitter, na.rm = TRUE)
  )%>%
  pivot_longer(news:twitter, names_to = "value", values_to = "gini")

gini_names4 <- c(
  'news'="News",
  'online_news'="Online news",
  'twitter'="Twitter",
  'STEM' = "STEM",
  'Medicine' = "Medicine",
  'Arts & Humanities' = "Arts & Humanities",
  'Social sciences' = "Social sciences"
)

png(height=8, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/within_prof_gini.png")

gini_per_prof %>%
  ggplot(aes(x=gini, fill = value, color = value)) +
  geom_histogram( alpha=0.6, position = 'identity') +
  labs(fill="")+
  theme_minimal_hgrid()+
  facet_grid(value~general_field, labeller = as_labeller(gini_names4))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Frequency")+
  xlab("Gini coefficient value")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x =  element_text(size = 11),
        legend.position = "none")

dev.off()

(gini_per_prof %>%
  ggplot(aes(x=gini, fill = value, color = value)) +
  geom_histogram( alpha=0.6, position = 'identity') +
  labs(fill="")+
  theme_minimal_hgrid()+
  facet_grid(value~general_field, labeller = as_labeller(gini_names4))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Frequency")+
  xlab("Gini coefficient value")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x =  element_text(size = 11),
        legend.position = "none"))
```


Looking at the totals:
```{r fig.width=12}
gini_overall <- gender_gini(sources_check,
                        pub_data = FALSE,
                        totals = TRUE,
                        year = 2023,
                        field = "all")

gini_overall_plot <- gini_overall %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_overall_plot$variable <- as.factor(unlist(gini_overall_plot$variable))

gini_names <- c(
  'gini_between'="(a) Between groups",
  'gini_within'="(b) Within groups",
  'total_gini'="(c) Overall"
)


  
png(height=4, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/overall_totals.png")

gini_overall_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=variable, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()

(gini_overall_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=variable, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```

And now yearly:
```{r fig.width=12}
years_individual <- c(2011:2023)


gini_overall_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

  for (i in 1:length(years_individual)){
    this_year <- years_individual[i]
    
    panel_year <- filter(prof_panel_filter,
                          year == this_year)
    
    gini_this_year <- gender_gini(panel_year,
                        pub_data = FALSE,
                        totals = FALSE,
                        year = this_year,
                        field = "all")
    
    gini_overall_yearly <- rbind(gini_overall_yearly,
                                 gini_this_year)
    
    
  }

gini_overall_yearly_plot <- gini_overall_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_overall_yearly_plot$variable <- as.factor(unlist(gini_overall_yearly_plot$variable))
gini_overall_yearly_plot$year <- as.numeric(unlist(gini_overall_yearly_plot$year))

png(height=4, width=10, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_totals.png")

gini_overall_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()

(gini_overall_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_wrap(gini_type~., scales = "free_y", labeller = as_labeller(gini_names))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))
)
```

## Inequality within fields

Overall gini in 2023 within the fields:
```{r fig.width=12}
fields <- unique(sources_check$general_field)
fields <- fields[1:4]

gini_per_field <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

  for (j in 1:length(fields)){
    this_field <- fields[j]
    
    sources_check_field <- filter(sources_check,
                                   entry_batch_2023 == year_group & general_field == this_field)
    
    gini_this_field <- gender_gini(sources_check_field,
                        pub_data = FALSE,
                        totals = TRUE,
                        year = 2023,
                        field = this_field)
    
    gini_per_field <- rbind(gini_per_field,
                            gini_this_field)
    
    
  }

gini_field_plot <- gini_per_field %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_field_plot$variable <- as.factor(unlist(gini_field_plot$variable))
gini_field_plot$field <- as.factor(unlist(gini_field_plot$field))


  
png(height=4, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/field_totals.png")

gini_field_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(.~gini_type, scales = "free_y", labeller = as_labeller(gini_names))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()

(gini_field_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(.~gini_type, scales = "free_y", labeller = as_labeller(gini_names))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```
And now yearly:
```{r fig.width=12}
years_individual <- c(2011:2023)

gini_field_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

for (j in 1:length(fields)){
  this_field <- fields[j]
  for (i in 1:length(years_individual)){
    this_year <- years_individual[i]
    
    panel_year <- filter(prof_panel_filter,
                         year == this_year & general_field == this_field)
    
    gini_this_year <- gender_gini(panel_year,
                                  pub_data = FALSE,
                                  totals = FALSE,
                                  year = this_year,
                                  field = this_field)
    
    gini_field_yearly <- rbind(gini_field_yearly,
                               gini_this_year)
    
    
  }
}

gini_field_yearly_plot <- gini_field_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_field_yearly_plot$variable <- as.factor(unlist(gini_field_yearly_plot$variable))
gini_field_yearly_plot$field <- as.factor(unlist(gini_field_yearly_plot$field))
gini_field_yearly_plot$year <- as.numeric(unlist(gini_field_yearly_plot$year))



gini_names2 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'STEM' = "STEM",
  'Medicine' = "Medicine",
  'Arts & Humanities' = "Arts & Humanities",
  'Social sciences' = "Social sciences"
)


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field.png")

gini_field_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~field, scales = "free_y", labeller = as_labeller(gini_names2))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()

(gini_field_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~field, scales = "free_y", labeller = as_labeller(gini_names2))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```
## Inequality within fields and cohorts

Within the fields and cohorts:
```{r fig.width=12}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]


gini_per_field_cohort <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

gini_names3 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'up to 10' = "up to 10",
  'up to 20' = "up to 20",
  'up to 30' = "up to 30",
  'up to 40' = "up to 40",
  'up to 50' = "up to 50"
)


for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    this_field <- fields[j]
    
    sources_check_cohort <- filter(sources_check,
                                   entry_batch_2023 == year_group & general_field == this_field)
    
    gini_this_field_cohort <- gender_gini(sources_check_cohort,
                                          pub_data = FALSE,
                                          totals = TRUE,
                                          year = 2023,
                                          field = this_field)
    
    gini_this_field_cohort$cohort <- year_group
    
    gini_per_field_cohort <- rbind(gini_per_field_cohort,
                                   gini_this_field_cohort)
    
  }
}



gini_per_field_cohort_plot <- gini_per_field_cohort %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_per_field_cohort_plot$variable <- as.factor(unlist(gini_per_field_cohort_plot$variable))
gini_per_field_cohort_plot$field <- as.factor(unlist(gini_per_field_cohort_plot$field))

  
png(height=10, width=14, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/field_cohort_totals.png")

gini_per_field_cohort_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(cohort~gini_type, scales = "free_y", labeller = as_labeller(gini_names3))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))

dev.off()   

(gini_per_field_cohort_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between"))%>%
  ggplot(.,aes(y=gini, x=field, fill = variable)) + 
    geom_bar(position="dodge", stat="identity")+
  facet_grid(cohort~gini_type, scales = "free_y", labeller = as_labeller(gini_names3))+
  #scale_x_discrete(labels= c("News", "Online news", "Twitter"))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Covariate")+
  labs(fill = "Attention type")+
    theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_blank(),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```
Within the fields and cohorts per year:
```{r gini_fields_cohorts, fig.width=12}
year_groups <- unique(sources_check$entry_batch_2023)
year_groups <- year_groups[! year_groups == "up to NA"]
years <- c("up to 10","up to 20", "up to 30", "up to 40", "up to 50")
year_groups <- year_groups[order(match(year_groups,years))]

years_individual <- c(2011:2023)
    
gini_per_field_cohort_yearly <-  data.frame(matrix(NA, nrow = 0, ncol = 9))

gini_names3 <- c(
  'gini_between'="Between groups",
  'gini_within'="Within groups",
  'total_gini'="Overall",
  'up to 10' = "up to 10",
  'up to 20' = "up to 20",
  'up to 30' = "up to 30",
  'up to 40' = "up to 40",
  'up to 50' = "up to 50"
)


for (i in 1:length(year_groups)){
  year_group <- year_groups[i]
  
  for (j in 1:length(fields)){
    this_field <- fields[j]
    for (k in 1:length(years_individual)){
      this_year <- years_individual[k]
      
      panel_year <- filter(prof_panel_filter,
                           entry_batch_2023 == year_group & general_field == this_field & year == this_year)
      
      if (nrow(panel_year)>0){
      
      gini_this_year <- gender_gini(panel_year,
                                    pub_data = FALSE,
                                    totals = FALSE,
                                    year = this_year,
                                    field = this_field)
      
      gini_this_year$cohort <- year_group
      gini_this_year$year <- this_year
      
      gini_per_field_cohort_yearly <- rbind(gini_per_field_cohort_yearly,
                                            gini_this_year)
      }
      
    }
  }
}



gini_per_field_cohort_yearly_plot <- gini_per_field_cohort_yearly %>% 
  pivot_longer(total_gini:gini_women, names_to = "gini_type", values_to = "gini")
gini_per_field_cohort_yearly_plot$variable <- as.factor(unlist(gini_per_field_cohort_yearly_plot$variable))
gini_per_field_cohort_yearly_plot$field <- as.factor(unlist(gini_per_field_cohort_yearly_plot$field))
gini_per_field_cohort_yearly_plot$year <- as.numeric(unlist(gini_per_field_cohort_yearly_plot$year))


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_stem.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "STEM")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()

png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_soc_sci.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Social sciences")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_medicine.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Medicine")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()


png(height=8, width=11, 
    unit = "in", 
    res = 600,
    file="results/suppl/gini/yearly_field_cohort_arts_hum.png")

gini_per_field_cohort_yearly_plot%>%
  filter(gini_type %in% c("total_gini", "gini_within", "gini_between") & field == "Arts & Humanities")%>%
  ggplot(.,aes(y=gini, x=year, fill = variable, color = variable)) + 
  geom_line()+
  facet_grid(gini_type~cohort, scales = "free_y", labeller = as_labeller(gini_names3))+
  scale_fill_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  ylab("Gini coefficient value")+
  xlab("Year")+
  labs(fill = "Attention type",
       color = "Attention type")+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))


dev.off()
```



# Attention capture by top 10%

## Overall women

How much attention, per year, is captured by women?
```{r overall_women, fig.width=12}
news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender)%>%
  summarise(total = sum(news_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
news_capture$source <- "news"

online_news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender)%>%
  summarise(total = sum(alt_online_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
online_news_capture$source <- "online_news"

twitter_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender)%>%
  summarise(total = sum(alt_twitter, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
twitter_capture$source <- "twitter"

representation <- repr_field_2023[, c(1,4)]

capture_gender <- rbind(news_capture,
                        online_news_capture,
                        twitter_capture)


(capture_gender_only <- capture_gender %>% 
  filter(inferred_gender == "w")%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
   geom_hline(data=repr_field_2023, aes(yintercept=share_women_field),  linetype='dashed',colour="grey") +
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of total attention captured by women")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```


Check how much attention, per year, is captured by the top 10% of professors.

## Overall capture
```{r overall_capture, fig.width=12}
news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field,news_all_top_10)%>%
  summarise(total = sum(news_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
news_capture$source <- "news"
colnames(news_capture)[3] <- "top_10"

online_news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, alt_online_all_top_10)%>%
  summarise(total = sum(alt_online_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
online_news_capture$source <- "online_news"
colnames(online_news_capture)[3] <- "top_10"

twitter_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, alt_twitter_top_10)%>%
  summarise(total = sum(alt_twitter, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
twitter_capture$source <- "twitter"
colnames(twitter_capture)[3] <- "top_10"


top_10_capture_overall <- rbind(news_capture,
                        online_news_capture,
                        twitter_capture)


(top_10_capture <- top_10_capture_overall %>% 
  filter(top_10 == 1)%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of total attention captured by professors in top 10%")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
  
```

## By field, with gender
Gender and field:
```{r by_field_gender, fig.width=12}
news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, news_all_top_10)%>%
  summarise(total = sum(news_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
news_capture$source <- "news"
colnames(news_capture)[4] <- "top_10"

online_news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, alt_online_all_top_10)%>%
  summarise(total = sum(alt_online_all, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
online_news_capture$source <- "online_news"
colnames(online_news_capture)[4] <- "top_10"

twitter_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, alt_twitter_top_10)%>%
  summarise(total = sum(alt_twitter, na.rm = TRUE))%>%
  group_by(year, general_field)%>%
  mutate(share = total / sum(total))
twitter_capture$source <- "twitter"
colnames(twitter_capture)[4] <- "top_10"

top_10_capture_field_gender <- rbind(news_capture,
                                     online_news_capture,
                                     twitter_capture)


(top_10_man_capture <- top_10_capture_field_gender %>% 
  filter(top_10 == 1 & inferred_gender == "m")%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of total attention captured by the men in top 10%")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))

(top_10_woman_capture <- top_10_capture_field_gender %>% 
  filter(top_10 == 1 & inferred_gender == "w")%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of total attention captured by the women in top 10%")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```

## By field, within gender

What about capture by famous women within women, and famous men within men?

Gender and field:
```{r by_field_within_g, fig.width=12}
library(knitr)
print(opts_current$get()$label)
news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, news_all_top_10)%>%
  summarise(total = sum(news_all, na.rm = TRUE))%>%
  group_by(year, general_field, inferred_gender)%>%
  mutate(share = total / sum(total))
news_capture$source <- "news"
colnames(news_capture)[4] <- "top_10"

online_news_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, alt_online_all_top_10)%>%
  summarise(total = sum(alt_online_all, na.rm = TRUE))%>%
  group_by(year, general_field, inferred_gender)%>%
  mutate(share = total / sum(total))
online_news_capture$source <- "online_news"
colnames(online_news_capture)[4] <- "top_10"

twitter_capture <- prof_panel_filter %>%
  filter(year >= 2012)%>%
  group_by(year, general_field, inferred_gender, alt_twitter_top_10)%>%
  summarise(total = sum(alt_twitter, na.rm = TRUE))%>%
  group_by(year, general_field, inferred_gender)%>%
  mutate(share = total / sum(total))
twitter_capture$source <- "twitter"
colnames(twitter_capture)[4] <- "top_10"

top_10_capture_field_within_gender <- rbind(news_capture,
                                     online_news_capture,
                                     twitter_capture)


(top_10_within_man_capture <- top_10_capture_field_within_gender %>% 
  filter(top_10 == 1 & inferred_gender == "m")%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of men's attention captured by the men in top 10%")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))

(top_10_within_woman_capture <- top_10_capture_field_within_gender %>% 
  filter(top_10 == 1 & inferred_gender == "w")%>%
  ggplot( aes(x=year, y=share, color = source)) +
  geom_line(size = 1.2)+
  xlab("Year")+
  ylab("Share of attention")+
  ggtitle("Share of women' attention captured by the women in top 10%")+
  scale_color_manual(labels = c("News", "Online news", "Twitter"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  facet_grid(.~general_field)+
  labs(color = "Attention type")+
  theme_minimal_vgrid()+
  theme(plot.title = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10)))
```


Write it all out:
```{r}

png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_women_all.png")

capture_gender_only
dev.off()

png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_top_10_all.png")

top_10_capture
dev.off()

png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_top_10_men.png")

top_10_man_capture
dev.off()

png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_top_10_women.png")

top_10_woman_capture
dev.off()


png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_top_10_men_within.png")

top_10_within_man_capture
dev.off()


png(height=5, width=12, 
    unit = "in", 
    res = 600,
    file="results/suppl/capture/capture_top_10_women_within.png")

top_10_within_woman_capture
dev.off()
```
