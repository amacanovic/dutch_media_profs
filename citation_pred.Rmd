---
title: "Various analyses - May 2024, final dataset"
author: "Ana Macanovic"
date: "2024-05-15"
---


Load the packages:
```{r message=  F, warning = F, eval = T}
source("helper_functions.R")

packages_to_load <- c("readr", "dplyr", "tidyr", 
                      "ggplot2", "cowplot",
                      "tidyverse", "RPostgres", 
                      "lubridate", "lmtest", 
                      "sandwich", "ggpubr", 
                      "knitr", "scales", 
                      "ggeffects", "flextable", 
                      "officer")

fpackage_check(packages_to_load)


# For full reproducibility, load the packages with groundhog using the code below instead
# of the fpackage_check function

# library(groundhog)
# groundhog.library(packages_to_load, date = "2024-4-23")
```


```{r}
opts_chunk$set(echo = TRUE)
opts_chunk$set(eval = TRUE)
opts_chunk$set(warning = FALSE)
opts_chunk$set(message = FALSE)
```


Load the panel and tidy up some columns:
```{r warning = F, message = F}
prof_panel <- read_csv("panel_datasets/prof_panel_tidy_26_7.csv")

prof_panel_filter <- filter(prof_panel,
                            year < 2024 & !is.na(general_field))

prof_panel_filter$coa_online_all_total <- prof_panel_filter$coa_online_news_total + prof_panel_filter$coa_blogs_total
prof_panel_filter$coa_online_all_total_l <- prof_panel_filter$coa_online_news_total_l + prof_panel_filter$coa_blogs_total_l
prof_panel_filter$coa_online_all <- prof_panel_filter$coa_online_news + prof_panel_filter$coa_blogs
prof_panel_filter$coa_online_all_l <- prof_panel_filter$coa_online_news_l + prof_panel_filter$coa_blogs_l

prof_panel_filter$coa_tot_online_all_total <- prof_panel_filter$coa_tot_online_news_total + prof_panel_filter$coa_tot_blogs_total
prof_panel_filter$coa_tot_online_all_total_l <- prof_panel_filter$coa_tot_online_news_total_l + prof_panel_filter$coa_tot_blogs_total_l
prof_panel_filter$coa_tot_online_all <- prof_panel_filter$coa_tot_online_news + prof_panel_filter$coa_tot_blogs
prof_panel_filter$coa_tot_online_all_l <- prof_panel_filter$coa_tot_online_news + prof_panel_filter$coa_tot_blogs_l

prof_panel_filter$coa_online_all <- prof_panel_filter$coa_online_news + prof_panel_filter$coa_blogs
```

# Regression models

First, obtain binary variables for any attention received that year:
```{r}
prof_panel_filter$any_news <- as.factor(ifelse(prof_panel_filter$news_all > 0, 1, 0))
prof_panel_filter$any_news_l <- as.factor(ifelse(prof_panel_filter$news_all_l > 0, 1, 0))

prof_panel_filter$any_online_news <- as.factor(ifelse(prof_panel_filter$alt_online_all > 0, 1, 0))
prof_panel_filter$any_online_news_l <- as.factor(ifelse(prof_panel_filter$alt_online_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_gen <- as.factor(ifelse(prof_panel_filter$alt_online_general_all > 0, 1, 0))
prof_panel_filter$any_online_news_gen_l <- as.factor(ifelse(prof_panel_filter$alt_online_general_all_l > 0, 1, 0))

prof_panel_filter$any_online_news_name <- as.factor(ifelse(prof_panel_filter$alt_online_name_all > 0, 1, 0))
prof_panel_filter$any_online_news_name_l <- as.factor(ifelse(prof_panel_filter$alt_online_name_all_l > 0, 1, 0))

prof_panel_filter$any_twitter <- as.factor(ifelse(prof_panel_filter$alt_twitter > 0, 1, 0))
prof_panel_filter$any_twitter_l <- as.factor(ifelse(prof_panel_filter$alt_twitter_l > 0, 1, 0))
```

Then, construct a binary variables for belonging to the top 10/20% in the attention for each source.
```{r}
panel_filter_long <- prof_panel_filter %>%
  pivot_longer(c(alt_online_all, alt_online_name_all, news_all, alt_twitter), names_to = "measure", values_to = "value")

top_10_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.90, na.rm = TRUE)<=value)%>%
  select(profile_id, general_field, year, measure, value)

top_10_attn$measure <- paste0(top_10_attn$measure, "_top_10")


top_10_attn <- top_10_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_10'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_10_attn[c("year", "profile_id", "general_field", "alt_online_all_top_10", "alt_online_name_all_top_10", "alt_twitter_top_10", "news_all_top_10")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

top_20_attn <- panel_filter_long %>%
  filter(!is.na(general_field) & !is.na(year) & year > 2011)%>%
  group_by(general_field, year, measure)%>%
  filter(quantile(value, 0.80, na.rm = TRUE)<=value)%>%
  select(profile_id, general_field, year, measure, value)

top_20_attn$measure <- paste0(top_20_attn$measure, "_top_20")


top_20_attn <- top_20_attn %>%
  pivot_wider(names_from = "measure")%>%
  mutate(across(contains('top_20'),  ~ifelse(is.na(.), 0, 1)))

prof_panel_filter <- merge(prof_panel_filter,
                           top_20_attn[c("year", "profile_id", "general_field", "alt_online_all_top_20", "alt_online_name_all_top_20", "alt_twitter_top_20", "news_all_top_20")],
                           by = c("profile_id", "year", "general_field"),
                           all.x = TRUE,
                           all.y = FALSE)

prof_panel_filter <- filter(prof_panel_filter, !is.na(general_field))

# if NA, needs to be 0
prof_panel_filter <- prof_panel_filter %>%
  mutate(across(contains('top_10'),  ~ifelse(is.na(.), 0, .)))%>%
  mutate(across(contains('top_20'),  ~ifelse(is.na(.), 0, .)))
```
Log of variables:
```{r}
prof_panel_filter$news_all_log <- log(prof_panel_filter$news_all+1)
prof_panel_filter$news_all_l_log <- log(prof_panel_filter$news_all_l+1)

prof_panel_filter$alt_online_all_log <- log(prof_panel_filter$alt_online_all+1)
prof_panel_filter$alt_online_all_l_log <- log(prof_panel_filter$alt_online_all_l+1)

prof_panel_filter$alt_twitter_log <- log(prof_panel_filter$alt_twitter+1)
prof_panel_filter$alt_twitter_l_log <- log(prof_panel_filter$alt_twitter_l+1)
# there is a problem with this variable
prof_panel_filter$cited_by_total_all_l_log <- log(prof_panel_filter$cited_by_total_all_l+1)
prof_panel_filter$cited_by_total_all_l_log[which(is.nan(prof_panel_filter$cited_by_total_all_l_log))] <- NA
prof_panel_filter$cited_by_total_all_l_log[which(is.infinite(prof_panel_filter$cited_by_total_all_l_log))] <- NA
prof_panel_filter$alt_online_all_total_l_log <- log(prof_panel_filter$alt_online_all_total_l+1)
prof_panel_filter$alt_twitter_total_l_log <- log(prof_panel_filter$alt_twitter_total_l+1)
prof_panel_filter$coa_tot_cited_by_total_l_log <- log(prof_panel_filter$coa_tot_cited_by_total_l+1)
prof_panel_filter$coa_online_all_total_l_log <- log(prof_panel_filter$coa_online_all_total_l+1)
prof_panel_filter$coa_twitter_total_l_log <- log(prof_panel_filter$coa_twitter_total_l+1)

prof_panel_filter$news_all_total_l_log <- log(prof_panel_filter$news_all_total_l+1)

```

Split datasets per field:
```{r}
stem <- filter(prof_panel_filter, general_field == "STEM")
soc_sci <- filter(prof_panel_filter, general_field == "Social sciences")
arts <- filter(prof_panel_filter, general_field == "Arts and Humanities")
medicine <- filter(prof_panel_filter, general_field == "Medicine")
```

## Main models

See "helper_functions.R" for details on the function we use to fit the models.

This function returns a list containing:

1. the model coefficients
2. the prediction per gender
3. pairwise testing of significance of predictions for men and women

We then use this output to plot our results and output the final model
tables.

### News attention


```{r warning = F}
news_formula_main_model <- "cited_by ~ inferred_gender + news_all_total_l + alt_online_all_total_l + alt_twitter_total_l +coa_tot_cited_by_total_l + coa_tot_online_all_total_l + coa_tot_twitter_total_l+years_since_first_pub + as.factor(year)"

news_main_model <- lm_fitter_cl_robust(panel_dataset = prof_panel_filter,
                                       lm_formula = news_formula_main_model,
                                       year_cutoff_upper = 2023,
                                       year_cutoff_lower = 2012)
```

Plot gender differences:
```{r fig.height=3, figh.width = 4}
# use the pairwise comparisons to compare groups in the plot
p_values <- news_main_model[[3]]
# manually add some elements we need to everything to look good
p_values$x <- c(1, 2, 3, 4)
p_values$groups <- 'c("m", "w")'
p_values$xmin <- c(0.8, 1.8, 2.8, 3.8)
p_values$xmax <- c(1.2, 2.2, 3.2, 4.2)

predictions_plot <- news_main_model[[2]]

news_gender_plot <- predictions_plot %>%
  ggplot(aes(x = field,
             y = predicted,
             ymin = conf.low,
             ymax = conf.high,
             color = x)) +
  geom_pointrange(position = position_dodge(width = 0.5),
                  size = 0.5)+
  ggtitle("Citation prediction")+
  scale_y_continuous(limits = c(0, 1260), breaks = seq(0, 1260, by = 315))+
  stat_pvalue_manual(
    p_values,
    y.position = c(930, 1240, 390, 120),
    label.size = 3,
    tip.length = 0.003,
    label = "{stars}",
    remove.bracket = FALSE,
  )+
  xlab("Field")+
  scale_x_discrete(labels=c("arts" = "Arts and\n Humanities",
                            "medicine" = "Medicine",
                            "soc_sci" = "Social sciences",
                            "stem" = "STEM"))+
  ylab("Yearly attention")+
  labs(color = "Inferred gender")+
  scale_color_manual(values = c("#34d399", "#fbbf24"), labels = c("Men", "Women"))+
  theme_minimal_hgrid()+
  theme(plot.title = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 10, angle = 30, hjust = 0.9) ,
        axis.title.x = element_text(size = 11),
        legend.title=element_text(size=11), 
        legend.text=element_text(size=10))
```

### Combined plots
Combine this all to plot the coefficients in one plot.

First, prepare the dataframe:
```{r}
model_news <- news_main_model[[1]]
model_news$model <- "Citations"

all_models_plot <- rbind(model_news)

# do the t-1 of dependent as a single variable
all_models_plot$term <- ifelse(all_models_plot$term %in% c("news_all_l",
                                                           "alt_online_all_l",
                                                           "alt_twitter_l"), 
                               "t_min_1", 
                               all_models_plot$term)


all_models_plot$term <- ordered(all_models_plot$term,
                                levels = c("(Intercept)",
                                           "inferred_genderw",
                                           "t_min_1",
                                           "cited_by_total_all_l",
                                           "news_all_total_l",
                                           "alt_online_all_total_l", 
                                           "alt_twitter_total_l",
                                           "coa_tot_cited_by_total_l",
                                           "coa_tot_online_all_total_l",
                                           "coa_tot_twitter_total_l",
                                           "years_since_first_pub",
                                           "as.factor(year)2014",
                                           "as.factor(year)2015",
                                           "as.factor(year)2016",
                                           "as.factor(year)2017",
                                           "as.factor(year)2018",
                                           "as.factor(year)2019",
                                           "as.factor(year)2020",
                                           "as.factor(year)2021",
                                           "as.factor(year)2022",
                                           "as.factor(year)2023",
                                           "R^2"))

all_models_plot$model <- ordered(all_models_plot$model,
                                 levels = c("News attention",
                                            "Online news attention",
                                            "Twitter attention" ))


all_models_plot$field <- ordered(all_models_plot$field,
                                 levels = c("stem",
                                            "soc_sci",
                                            "medicine",
                                            "arts"))

covariate_names <- c(
  't_min_1' = "Dependent variable -\n previous period",
  'inferred_genderw' = "Inferred gender \n (ref: man)",
  'news_all_l'="News attention -\nprevious period",
  'alt_online_all_l' = "Online news attention -\nprevious period",
  'alt_twitter_l' = "Twitter attention -\nprevious period",
  'cited_by_total_all_l'="Total citations",
  'news_all_total_l'="Total printed news \nattention",
  'alt_online_all_total_l'="Total online news\n attention",
  'alt_twitter_total_l'="Total Twitter/X \nattention",
  'coa_tot_cited_by_total_l' = "Coauthors' total \ncitations",
  'coa_tot_online_all_total_l' = "Coauthors' total \nonline news attention",
  'coa_tot_twitter_total_l' = "Coauthors' total \nTwitter/X attention"
)
```


Plot out selected regression coefficients for STEM:
```{r fig.width=12, fig.height= 4, warning = F}
# reorder the factor for Figure 2
all_models_plot$term <- ordered(all_models_plot$term,
                                     levels = c("(Intercept)",
                                                "inferred_genderw",
                                                "cited_by_total_all_l",
                                                "news_all_total_l",
                                                "alt_online_all_total_l", 
                                                "alt_twitter_total_l",
                                                "coa_tot_cited_by_total_l",
                                                "coa_tot_online_all_total_l",
                                                "coa_tot_twitter_total_l",
                                                "t_min_1",
                                                "as.factor(year)2014",
                                                "as.factor(year)2015",
                                                "as.factor(year)2016",
                                                "as.factor(year)2017",
                                                "as.factor(year)2018",
                                                "as.factor(year)2019",
                                                "as.factor(year)2020",
                                                "as.factor(year)2021",
                                                "as.factor(year)2022",
                                                "as.factor(year)2023",
                                                "R^2"))


(selected_plot <- all_models_plot %>%
    filter(term %in% c("news_all_total_l",
                       "inferred_genderw",
                       "alt_online_all_total_l", 
                       "alt_twitter_total_l",
                       "coa_tot_cited_by_total_l",
                       "coa_tot_online_all_total_l",
                       "coa_tot_twitter_total_l",
                       "t_min_1")) %>%
  ggplot(aes(Estimate, field, color = model, label = stars)) +
  geom_point(position = position_dodge(width = -0.7), size = 3) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci),
                width=0,
                size=0.7,
                position = position_dodge(width = -0.7)) +
  geom_text(hjust=0, vjust=0, position = position_dodge(width = -0.7), size = 3.5)+
   scale_y_discrete(labels=c("arts" = "Arts and Humanities",
                             "medicine" = "Medicine",
                             "soc_sci" = "Social sciences",
                             "stem" = "STEM"),
                       name = "Field")+
  scale_color_manual(labels = c("Printed news", "Online news", "Twitter/X"), values = c("#F8766D", "#00BA38", "#619CFF"))+
  scale_x_continuous(
    n.breaks = 3,
    labels = function(x) format(x, scientific = TRUE))+
  # add in a dotted line at zero
  labs(
    x = "Regression coefficient",
    y = NULL,
    color = "Attention type"
  ) + 
  geom_vline(xintercept = 0,  colour="black", linetype = "longdash")+
  facet_wrap( ~ term, scales="free_x", labeller = as_labeller(covariate_names), ncol = 7)+
  theme_bw()+
   theme(plot.title = element_text(size = 10),
         axis.text.y = element_text(size = 10),
         axis.title.y = element_blank(),
         axis.text.x = element_text(size = 10, angle = 30, hjust = 0.9) ,
         axis.title.x = element_text(size = 11),
         legend.title=element_text(size=10), 
         legend.text=element_text(size=9),
         strip.text.x=element_text(size = 9)))
```